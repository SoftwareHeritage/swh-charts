namespace: swh-cassandra-next-version

postgresqlWebConfiguration:
  host: next-version-dbs-rw
  port: 5432
  db: swh-web
  user: swh-web
  pass: ${POSTGRESQL_PASSWORD}
  secrets:
    POSTGRESQL_PASSWORD:
      secretKeyRef: swh-postgresql-web-secrets
      secretKeyName: postgres-swh-web-password

postgresqlVaultConfiguration:
  host: next-version-dbs-rw
  port: 5432
  db: swh-vault
  user: swh-vault
  pass: ${POSTGRESQL_PASSWORD}
  secrets:
    POSTGRESQL_PASSWORD:
      secretKeyRef: swh-vault-postgresql-secret
      secretKeyName: postgres-swh-vault-password

remoteVaultConfiguration:
  cls: remote
  url: http://vault-rpc-ingress-next-version

vault:
  replicas: 1
  vaultConfigurationRef: postgresqlVaultConfiguration
  autoScaling:
    minReplicaCount: 1
    maxReplicaCount: 1
  hosts:
    - vault-rpc-ingress-next-version

remoteCountersConfiguration:
  cls: remote
  url: http://counters-rpc-ingress-next-version

externalServices:
  enabled: true
  services:
    vault:
      internalName: vault-rpc-ingress-next-version
      target: archive-staging-rke2-ingress-nginx-controller.ingress-nginx.svc.cluster.local
    counters:
      internalName: counters-rpc-ingress-next-version
      target: archive-staging-rke2-ingress-nginx-controller.ingress-nginx.svc.cluster.local

counters:
  rpc:
    replicas: 1
    autoScaling:
      minReplicaCount: 1
      maxReplicaCount: 1
    hosts:
      - counters-rpc-ingress-next-version

loaders:
  terminationGracePeriodSeconds: 60
  deployments:
    # Force the deployment of one pod of each type to at least
    # ensure they start (not enough but it's a first step)
    add-forge-now:
      enabled: false
    add-forge-now-slow:
      enabled: false
    archive:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        stopWhenNoActivity: false
    bzr:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        stopWhenNoActivity: false
    cran:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        stopWhenNoActivity: false
    cvs:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        stopWhenNoActivity: false
    content:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        stopWhenNoActivity: false
    directory:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        stopWhenNoActivity: false
    git:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        stopWhenNoActivity: false
    git-checkout:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        stopWhenNoActivity: false
    hg-checkout:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        stopWhenNoActivity: false
    svn-export:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        stopWhenNoActivity: false
    debian:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        stopWhenNoActivity: false
    deposit:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        stopWhenNoActivity: false
    golang:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        stopWhenNoActivity: false
    save-code-now:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        stopWhenNoActivity: false
    maven:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        stopWhenNoActivity: false
    mercurial:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        stopWhenNoActivity: false
    npm:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        stopWhenNoActivity: false
    opam:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        stopWhenNoActivity: false
    pypi:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        stopWhenNoActivity: false
    pubdev:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        stopWhenNoActivity: false
    svn:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        stopWhenNoActivity: false

loader_metadata:
  terminationGracePeriodSeconds: 60
  autoScaling:
    queueThreshold: 1
    maxReplicaCount: 1
    # TODO: Support this option
    # stopWhenNoActivity: false

storage_replayer:
  # Force the deployment of one pod of each type to at least
  # ensure they start (not enough but it's a first step)
  deployments:
    content:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        # TODO: Support this option
        # stopWhenNoActivity: false
    directory:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        # TODO: Support this option
        # stopWhenNoActivity: false
    extid:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        # TODO: Support this option
        # stopWhenNoActivity: false
    metadata:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        # TODO: Support this option
        # stopWhenNoActivity: false
    raw-extrinsic-metadata:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        # TODO: Support this option
        # stopWhenNoActivity: false
    origin:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        # TODO: Support this option
        # stopWhenNoActivity: false
    origin-visit:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        # TODO: Support this option
        # stopWhenNoActivity: false
    origin-visit-status:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        # TODO: Support this option
        # stopWhenNoActivity: false
    release:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        # TODO: Support this option
        # stopWhenNoActivity: false
    revision:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        # TODO: Support this option
        # stopWhenNoActivity: false
    skipped-content:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        # TODO: Support this option
        # stopWhenNoActivity: false
    snapshot:
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
        # TODO: Support this option
        # stopWhenNoActivity: false

storage:
  deployments:
    cassandra:
      autoScaling:
        minReplicaCount: 1
        maxReplicaCount: 2
        cpuPercentageUsage: 150
      hosts:
        - storage-cassandra-next-version.internal.staging.swh.network
    cassandra-read-only:
      enabled: false

web:
  deployments:
    cassandra:
      metricsScrapingEnabled: false
      replicas: 1
      autoScaling:
        minReplicaCount: 1
        maxReplicaCount: 1
      extraConfig:
        history_counters_url: http://counters-rpc-ingress-next-version/counters_history/history.json#
      hosts:
        - webapp-cassandra-next-version.internal.staging.swh.network
      refreshSavecodenowStatus:
        enabled: false
      syncMailmaps:
        enabled: false
      ingress:
        whitelistSourceRangeRef: stagingNetworkRanges
        endpoints:
          default:
            paths:
              - path: /
              - path: /static
                port: 80
            extraWhitelistSourceRange:
              # vpn network
              - 192.168.101.0/24
          authenticated:
            paths:
              - path: /api/1/provenance/
              - path: /api/1/entity/
              - path: /api/1/content/[^/]+/symbol/
            # auth-file with authentication
            authentication: swh-cassandra/web-auth-secrets
            extraWhitelistSourceRange:
              # vpn network
              - 192.168.101.0/24

deposit:
  enabled: false

graphql:
  deployments:
    cassandra:
      replicas: 1
      hosts:
        - webapp-cassandra-next-version.internal.staging.swh.network

podPriority:
  # This test environment should not impact the real staging environment
  # so we need to use lower priorities than the 'normal' versions
  priorities:
    storages:
      value: -100000
    frontend-rpc:
      value: -10100
    frontend-rpc-workload:
      value: -10200
    high-workload:
      value: -10300
    local-workload:
      value: -10400
    normal-workload:
      value: -10500
    tools:
      value: -10600
    low-workload:
      value: -10700
    background-storage:
      value: -10800
    background-workload:
      value: -10900

scrubber:
  enabled: false

toolbox:
  enabled: false

objstorage:
  enabled: false

webhooks:
  enabled: false

listers:
  enabled: false

indexers:
  enabled: false

checker_deposit:
  enabled: false

search:
  enabled: false

scheduler:
  enabled: false

indexerStorage:
  enabled: false

cassandraChecks:
  enabled: false
