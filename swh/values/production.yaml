sentry:
  environment: production

graphql:
  enabled: true
  replicas: 2
  backends:
    storage:
      host: moma.internal.softwareheritage.org
      port: 5002
    search:
      host: moma.internal.softwareheritage.org
      port: 5010
  introspection: yes
  ingress:
    enabled: true
    host: graphql.internal.softwareheritage.org
    httpPath: /
  gunicorn:
    threads: 4
    workers: 2
    timeout: 3600
  auth:
    server: https://auth.softwareheritage.org/auth/
    realm: SoftwareHeritage
    client: swh-web
    cacheUrl: memcached://memcached:11211

loaders:
  enabled: true
  storage:
    host: saam.internal.softwareheritage.org
    port: 5002
  amqp:
    host: rabbitmq.internal.softwareheritage.org
  deployments:
    addforgenow:
      image: swh_loader_git_image
      requestedMemory: 256Mi
      requestedCpu: 200m
      queues:
        - add_forge_now:swh.loader.git.tasks.UpdateGitRepository
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 5
      sentrySwhPackage: swh.loader.git
    large-repository:
      image: swh_loader_git_image
      requestedMemory: 1024Mi
      requestedCpu: 800m
      queues:
        - oneshot:swh.loader.git.tasks.UpdateGitRepository
        - oneshot2:swh.loader.git.tasks.UpdateGitRepository
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 10
      sentrySwhPackage: swh.loader.git
      extraConfig:
        temp_file_cutoff: 10737418240
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: "swh/loader"
                operator: In
                values:
                - "true"
              - key: "swh/large-scratch-fs"
                operator: In
                values:
                - "true"
    cvs:
      requestedMemory: 256Mi
      requestedCpu: 200m
      queues:
        - swh.loader.cvs.tasks.LoadCvsRepository
      autoScaling:
        maxReplicaCount: 2
      sentrySwhPackage: swh.loader.cvs
    highpriority:
      requestedMemory: 256Mi
      requestedCpu: 200m
      queues:
        - save_code_now:swh.loader.cvs.tasks.LoadCvsRepository
      ackLate: true
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 3
      # HACK: As there is only 1 cvs queue consumed, send cvs issues to sentry
      # See https://gitlab.softwareheritage.org/swh/meta/-/issues/4949
      sentrySwhPackage: swh.loader.cvs

memcached:
  enabled: true
