# temporary appversion and graphql image version until this version is validated
# https://gitlab.softwareheritage.org/swh/infra/sysadm-environment/-/issues/4889
appVersion: 37
swh_graphql_image_version: '20230327.1'

sentry:
  environment: production

storagePipelineSteps:
  - cls: buffer
    min_batch_size:
      content: 1000
      content_bytes: 52428800
      directory: 1000
      directory_entries: 12000
      revision: 1000
      revision_parents: 2000
      revision_bytes: 52428800
      release: 1000
      release_bytes: 52428800
      extid: 1000
  - cls: filter
  - cls: retry

saamStorageConfiguration:
  cls: remote
  host: http://saam.internal.softwareheritage.org:5002

remoteStorageConfiguration:
  pipelineStepsRef: storagePipelineSteps
  storageConfigurationRef: saamStorageConfiguration

remoteROStorageConfiguration:
  # TODO: use a true read-only storage
  storageConfigurationRef: saamStorageConfiguration

graphql:
  enabled: true
  replicas: 2
  backends:
    storage:
      host: moma.internal.softwareheritage.org
      port: 5002
    search:
      host: moma.internal.softwareheritage.org
      port: 5010
  introspection: yes
  ingress:
    enabled: true
    host: graphql.internal.softwareheritage.org
    httpPath: /
  gunicorn:
    threads: 4
    workers: 2
    timeout: 3600
  auth:
    server: https://auth.softwareheritage.org/auth/
    realm: SoftwareHeritage
    client: swh-web
    cacheUrl: memcached://memcached:11211

listers:
  enabled: true
  storageConfigurationRef: remoteROStorageConfiguration
  scheduler:
    host: saatchi.internal.softwareheritage.org
    port: 5008
  amqp:
     host: saatchi.internal.softwareheritage.org
  deployments:
    pubdev:
      queues:
        - swh.lister.pubdev.tasks.PubDevListerTask
      autoScaling:
        maxReplicaCount: 1

loaders:
  enabled: true
  storageConfigurationRef: remoteStorageConfiguration
  amqp:
    host: rabbitmq.internal.softwareheritage.org
  deployments:
    add-forge-now:
      image: swh_loader_git_image
      requestedMemory: 1024Mi
      requestedCpu: 500m
      queues:
        - add_forge_now:swh.loader.git.tasks.UpdateGitRepository
      ackLate: true
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 6
    add-forge-now-slow:
      image: swh_loader_git_image
      requestedMemory: 1024Mi
      requestedCpu: 500m
      queues:
        - add_forge_now_slow:swh.loader.git.tasks.UpdateGitRepository
      ackLate: true
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
    pubdev:
      requestedMemory: 256Mi
      requestedCpu: 200m
      image: swh_loader_package_image
      queues:
        - swh.loader.package.pubdev.tasks.LoadPubDev
      autoScaling:
        maxReplicaCount: 1
    large-repository:
      image: swh_loader_git_image
      requestedMemory: 1024Mi
      requestedCpu: 800m
      queues:
        - large_repository:swh.loader.git.tasks.UpdateGitRepository
        # for retro-compatibility with running workers
        # FIXME: To drop when workers are done and queue is empty
        - oneshot2:swh.loader.git.tasks.UpdateGitRepository
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 12
      extraConfig:
        temp_file_cutoff: 10737418240
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: "swh/loader"
                operator: In
                values:
                - "true"
              - key: "swh/large-scratch-fs"
                operator: In
                values:
                - "true"
    cvs:
      requestedMemory: 256Mi
      requestedCpu: 200m
      queues:
        - swh.loader.cvs.tasks.LoadCvsRepository
      autoScaling:
        maxReplicaCount: 2
    save-code-now:
      requestedMemory: 2048Mi
      requestedCpu: 200m
      queues:
        - save_code_now:swh.loader.bzr.tasks.LoadBazaar
        - save_code_now:swh.loader.cvs.tasks.LoadCvsRepository
        - save_code_now:swh.loader.git.tasks.UpdateGitRepository
        - save_code_now:swh.loader.git.tasks.LoadDiskGitRepository
        - save_code_now:swh.loader.git.tasks.UncompressAndLoadDiskGitRepository
        - save_code_now:swh.loader.mercurial.tasks.LoadArchiveMercurial
        - save_code_now:swh.loader.mercurial.tasks.LoadMercurial
        - save_code_now:swh.loader.svn.tasks.LoadSvnRepository
        - save_code_now:swh.loader.svn.tasks.MountAndLoadSvnRepository
        - save_code_now:swh.loader.svn.tasks.DumpMountAndLoadSvnRepository
        - save_code_now:swh.loader.package.archive.tasks.LoadArchive
      ackLate: true
      autoScaling:
        stopWhenNoActivity: false
        queueThreshold: 1
        minReplicaCount: 16
        maxReplicaCount: 16

loader_metadata:
  enabled: true
  storage:
    host: saam.internal.softwareheritage.org
    port: 5002
  scheduler:
    host: saatchi.internal.softwareheritage.org
    port: 5008
  consumerGroup: loader_metadata.journal_client
  prefix: swh.journal.objects
  journalBrokers:
    secretName: swh-archive-broker-secret
    hosts:
      - kafka1.internal.softwareheritage.org:9094
      - kafka2.internal.softwareheritage.org:9094
      - kafka3.internal.softwareheritage.org:9094
      - kafka4.internal.softwareheritage.org:9094
    user: swh-archive-prod
  autoScaling:
    maxReplicaCount: 4

memcached:
  enabled: true
