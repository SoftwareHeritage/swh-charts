namespace: swh-cassandra
environment: production
sentry:
  environment: production

noopObjectStorage:
  cls: noop

cassandraSeeds:
  - cassandra01.internal.softwareheritage.org
  - cassandra02.internal.softwareheritage.org
  - cassandra03.internal.softwareheritage.org
  - cassandra04.internal.softwareheritage.org
  - cassandra05.internal.softwareheritage.org
  - cassandra06.internal.softwareheritage.org
  - cassandra07.internal.softwareheritage.org
  - cassandra08.internal.softwareheritage.org
  - cassandra09.internal.softwareheritage.org
  - cassandra10.internal.softwareheritage.org

cassandraStorage:
  cls: cassandra
  cassandraSeedsRef: cassandraSeeds
  keyspace: swh
  initKeyspace: false
  consistencyLevel: LOCAL_QUORUM
  specificOptions:
    directory_entries_insert_algo: batch
  authProvider:
    cls: cassandra.auth.PlainTextAuthProvider
    username: swh-rw
    password: ${CASSANDRA_PASSWORD}
  secrets:
    CASSANDRA_PASSWORD:
      secretKeyRef: common-secrets
      secretKeyName: cassandra-swh-rw-password

cassandraReplayerStorageConfiguration:
  storageConfigurationRef: cassandraStorage
  objectStorageConfigurationRef: noopObjectStorage

cassandraStorageConfiguration:
  storageConfigurationRef: cassandraStorage
  # TODO: add journal_writer
  # TODO: add objstorage configuration

# (Not so) readonly (namespace local) storage
# TODO: Use a true read-only storage
localRpcROStorageService:
  cls: remote
  host: http://storage:5002

localRpcROStorageConfiguration:
  storageConfigurationRef: localRpcROStorageService

searchConfiguration:
  cls: remote
  url: http://moma.internal.softwareheritage.org:5010

remoteSchedulerConfiguration:
  cls: remote
  url: http://scheduler.internal.softwareheritage.org

remoteVaultConfiguration:
  cls: remote
  url: http://vangogh.euwest.azure.internal.softwareheritage.org:5005/

remoteIndexerStorageConfiguration:
    cls: remote
    url: http://saam.internal.softwareheritage.org:5007/

remoteCountersConfiguration:
    cls: remote
    url: http://counters1.internal.softwareheritage.org:5011/

storage_replayer:
  enabled: true

  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: "swh/replayer"
            operator: In
            values:
            - "true"
  journalBrokers:
    hosts:
      - kafka1.internal.softwareheritage.org:9094
      - kafka2.internal.softwareheritage.org:9094
      - kafka3.internal.softwareheritage.org:9094
      - kafka4.internal.softwareheritage.org:9094
    user: swh-cassandra-prod
    groupIdName: cassandra
  storageConfigurationRef: cassandraReplayerStorageConfiguration
  error_reporter:
    host: redis-cassandra-replayers.redis
    port: 6379
    db: 1
  deployments:
    content:
      objects:
        - content
      privileged: true
      requestedCpu: 425m
      requestedMemory: 200Mi
      autoScaling:
        maxReplicaCount: 64
    directory:
      objects:
        - directory
      privileged: true
      batchSize: 250
      # Full replay
      requestedCpu: 500m
      requestedMemory: 250Mi
      # Follow up consumption
      # requestedMemory: 100Mi
      autoScaling:
        maxReplicaCount: 10
    extid:
      objects:
        - extid
      privileged: true
      batchSize: 1000
      # Full replay
      # requestedCpu: 400m
      requestedMemory: 200Mi
      #Follow up consumption
      requestedCpu: 50m
      autoScaling:
        maxReplicaCount: 5
    metadata:
      objects:
        - metadata_authority
        - metadata_fetcher
      privileged: true
      # follow up consumption
      requestedCpu: 50m
      requestedMemory: 100Mi
      autoScaling:
        maxReplicaCount: 5
    raw-extrinsic-metadata:
      objects:
        - raw_extrinsic_metadata
      privileged: true
      batchSize: 250
      # Full replay
      requestedCpu: 400m
      requestedMemory: 200Mi
      # follow up consumption
      # requestedCpu: 50m
      autoScaling:
        maxReplicaCount: 5
    origin:
      objects:
        - origin
      privileged: true
      batchSize: 1000
      # Full replay
      # requestedCpu: 400m
      requestedMemory: 200Mi
      #Follow up consumption
      requestedCpu: 50m
      autoScaling:
        maxReplicaCount: 5
    origin-visit:
      objects:
        - origin_visit
      privileged: true
      batchSize: 1000
      # Full replay
      requestedCpu: 400m
      requestedMemory: 400Mi
      #Follow up consumption
      # requestedCpu: 100m
      # requestedMemory: 100Mi
      autoScaling:
        maxReplicaCount: 5
    origin-visit-status:
      objects:
        - origin_visit_status
      privileged: true
      batchSize: 1000
      # Full replay
      requestedCpu: 500m
      requestedMemory: 300Mi
      #Follow up consumption
      # requestedCpu: 55m
      # requestedMemory: 200Mi
      autoScaling:
        maxReplicaCount: 5
    release:
      objects:
        - release
      privileged: true
      batchSize: 1000
      # Full replay
      # requestedCpu: 600m
      requestedMemory: 300Mi
      # follow up consumption
      requestedCpu: 50m
      autoScaling:
        maxReplicaCount: 5
    revision:
      objects:
        - revision
      batchSize: 1000
      privileged: true
      # Full replay
      # requestedCpu: 750m
      # requestedMemory: 750Mi
      # follow up consumption
      requestedCpu: 50m
      requestedMemory: 400Mi
      autoScaling:
        maxReplicaCount: 5
    skipped-content:
      objects:
        - skipped_content
      privileged: true
      batchSize: 100
      # Full replay
      # requestedCpu: 300m
      requestedMemory: 400Mi
      # follow up consumption
      requestedCpu: 50m
      autoScaling:
        maxReplicaCount: 5
    snapshot:
      objects:
        - snapshot
      privileged: true
      batchSize: 250
      # Full replay
      # requestedCpu: 400m
      requestedMemory: 250Mi
      # follow up consumption
      requestedCpu: 80m
      autoScaling:
        maxReplicaCount: 5

storage:
  enabled: true
  replicas: 2
  requestedCpu: 500m
  requestedMemory: 500Mi

  storageConfigurationRef: cassandraStorageConfiguration

  # TODO: move this to a proper objstorage template
  objstorageClass: multiplexer
  objstorageConfig: ${OBJSTORAGECONFIG}

web:
  enabled: true
  logLevel: INFO
  replicas: 2
  requestedCpu: 500m
  requestedMemory: 500Mi
  #autoScaling:
  #  maxReplicaCount: 5
  configSecretRef: swh-cassandra-webapp-config
  host: webapp-cassandra.internal.softwareheritage.org
  ingressAnnotations:
    cert-manager.io/cluster-issuer: letsencrypt-production-gandi
    kubernetes.io/ingress.class: nginx
    kubernetes.io/tls-acme: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
  tlsEnabled: true
  searchConfigurationRef: searchConfiguration
  metadataSearchBackend: swh-search
  schedulerConfigurationRef: remoteSchedulerConfiguration
  storageConfigurationRef: localRpcROStorageConfiguration
  vaultConfigurationRef: remoteVaultConfiguration
  indexerStorageConfigurationRef: remoteIndexerStorageConfiguration
  countersConfigurationRef: remoteCountersConfiguration
  djangoSecretKeySecret: common-secrets
  djangoSecretKeyName: webapp-django-secret-key
  throttling:
    cache_uri: memcached:11211
    scopes:
      swh_api:
        limiter_rate:
          default: 120/h
        exempted_networks:
        - 127.0.0.0/8
        - 192.168.100.0/23
        - 128.93.166.14
        - 131.107.174.0/24
        - 213.135.60.145
        - 213.135.60.146
        - 37.187.137.47
        - 37.187.96.121
      swh_api_origin_search:
        limiter_rate:
          default: 10/m
      swh_api_origin_visit_latest:
        limiter_rate:
          default: 700/m
      swh_vault_cooking:
        limiter_rate:
          default: 120/h
          GET: 60/m
        exempted_networks:
        - 127.0.0.0/8
        - 192.168.100.0/23
        - 128.93.166.14
        - 131.107.174.0/24
        - 213.135.60.145
        - 213.135.60.146
        - 37.187.96.121
      swh_save_origin:
        limiter_rate:
          default: 120/h
          POST: 10/h
        exempted_networks:
        - 127.0.0.0/8
        - 192.168.100.0/23
        - 128.93.166.14
        - 131.107.174.0/24
        - 213.135.60.145
        - 213.135.60.146
        - 37.187.96.121
      swh_raw_object:
        limiter_rate:
          default: 120/h

graphql:
  enabled: true
  replicas: 1
  storageConfigurationRef: localRpcROStorageConfiguration
  searchConfiguration:
    host: moma.internal.softwareheritage.org
    port: 5010
  introspection: yes
  ingress:
    enabled: true
    host: webapp-cassandra.internal.softwareheritage.org
    httpPath: /graphql/
  gunicorn:
    threads: 4
    workers: 2
    timeout: 3600
  auth:
    enabled: false
    server: https://auth.softwareheritage.org/auth/
    realm: SoftwareHeritage
    client: swh-web
    cacheUrl: memcached://memcached:11211
  maxRawContentSize: 10000

memcached:
  enabled: true

podPriority:
  enabled: true
