namespace: swh-cassandra

cassandraSeeds:
  - cassandra01.internal.softwareheritage.org
  - cassandra02.internal.softwareheritage.org
  - cassandra03.internal.softwareheritage.org
  - cassandra04.internal.softwareheritage.org
  - cassandra05.internal.softwareheritage.org
  - cassandra06.internal.softwareheritage.org
  - cassandra07.internal.softwareheritage.org
  - cassandra08.internal.softwareheritage.org
  - cassandra09.internal.softwareheritage.org
  - cassandra10.internal.softwareheritage.org

cassandraStorage:
  cls: cassandra
  cassandraSeedsRef: cassandraSeeds
  keyspace: swh
  initKeyspace: false
  consistencyLevel: LOCAL_QUORUM
  specificOptions:
    directory_entries_insert_algo: batch
  authProvider:
    cls: cassandra.auth.PlainTextAuthProvider
    username: swh-rw
    password: ${CASSANDRA_PASSWORD}
  secrets:
    CASSANDRA_PASSWORD:
      secretKeyRef: common-secrets
      secretKeyName: cassandra-swh-rw-password

cassandraROStorage:
  cls: cassandra
  cassandraSeedsRef: cassandraSeeds
  keyspace: swh
  initKeyspace: true
  consistencyLevel: LOCAL_QUORUM
  authProvider:
    cls: cassandra.auth.PlainTextAuthProvider
    username: swh-ro
    password: ${CASSANDRA_PASSWORD}
  secrets:
    CASSANDRA_PASSWORD:
      secretKeyRef: common-secrets
      secretKeyName: cassandra-swh-ro-password

cassandraReplayerStorageConfiguration:
  storageConfigurationRef: cassandraStorage
  objstorageConfigurationRef: noopObjectStorage

cassandraStorageConfiguration:
  storageConfigurationRef: cassandraStorage
  # TODO: add objstorage configuration
  objstorageConfigurationRef: roObjstorageConfiguration

scrubberROStorageConfiguration:
  storageConfigurationRef: cassandraROStorage

# (Not so) readonly (namespace local) storage
# TODO: Use a true read-only storage
localRpcROStorageService:
  cls: remote
  url: http://storage:5002

localRpcROStorageConfiguration:
  storageConfigurationRef: localRpcROStorageService

remoteStorageConfiguration:
  cls: remote
  url: http://storage:5002

pipelineAzureROObjstorageConfiguration:
  cls: multiplexer
  objstorages:
  - cls: filtered
    storage_conf:
      cls: azure-prefixed
      accounts:
        '0':
          account_name: ${0_ACCOUNT_NAME}
          api_secret_key: ${0_API_SECRET_KEY}
          container_name: contents
        '1':
          account_name: ${1_ACCOUNT_NAME}
          api_secret_key: ${1_API_SECRET_KEY}
          container_name: contents
        '2':
          account_name: ${2_ACCOUNT_NAME}
          api_secret_key: ${2_API_SECRET_KEY}
          container_name: contents
        '3':
          account_name: ${3_ACCOUNT_NAME}
          api_secret_key: ${3_API_SECRET_KEY}
          container_name: contents
        '4':
          account_name: ${4_ACCOUNT_NAME}
          api_secret_key: ${4_API_SECRET_KEY}
          container_name: contents
        '5':
          account_name: ${5_ACCOUNT_NAME}
          api_secret_key: ${5_API_SECRET_KEY}
          container_name: contents
        '6':
          account_name: ${6_ACCOUNT_NAME}
          api_secret_key: ${6_API_SECRET_KEY}
          container_name: contents
        '7':
          account_name: ${7_ACCOUNT_NAME}
          api_secret_key: ${7_API_SECRET_KEY}
          container_name: contents
        '8':
          account_name: ${8_ACCOUNT_NAME}
          api_secret_key: ${8_API_SECRET_KEY}
          container_name: contents
        '9':
          account_name: ${9_ACCOUNT_NAME}
          api_secret_key: ${9_API_SECRET_KEY}
          container_name: contents
        a:
          account_name: ${10_ACCOUNT_NAME}
          api_secret_key: ${10_API_SECRET_KEY}
          container_name: contents
        b:
          account_name: ${11_ACCOUNT_NAME}
          api_secret_key: ${11_API_SECRET_KEY}
          container_name: contents
        c:
          account_name: ${12_ACCOUNT_NAME}
          api_secret_key: ${12_API_SECRET_KEY}
          container_name: contents
        d:
          account_name: ${13_ACCOUNT_NAME}
          api_secret_key: ${13_API_SECRET_KEY}
          container_name: contents
        e:
          account_name: ${14_ACCOUNT_NAME}
          api_secret_key: ${14_API_SECRET_KEY}
          container_name: contents
        f:
          account_name: ${15_ACCOUNT_NAME}
          api_secret_key: ${15_API_SECRET_KEY}
          container_name: contents
    filters_conf:
    - type: readonly
  - cls: filtered
    storage_conf:
      cls: remote
      url: http://objstorage.internal.softwareheritage.org:5003/
    filters_conf:
    - type: readonly

roObjstorageConfiguration:
  configurationRef: pipelineAzureROObjstorageConfiguration
  secrets:
    0_ACCOUNT_NAME:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 0_account_name
    0_API_SECRET_KEY:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 0_api_secret_key
    1_ACCOUNT_NAME:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 1_account_name
    1_API_SECRET_KEY:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 1_api_secret_key
    2_ACCOUNT_NAME:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 2_account_name
    2_API_SECRET_KEY:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 2_api_secret_key
    3_ACCOUNT_NAME:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 3_account_name
    3_API_SECRET_KEY:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 3_api_secret_key
    4_ACCOUNT_NAME:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 4_account_name
    4_API_SECRET_KEY:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 4_api_secret_key
    5_ACCOUNT_NAME:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 5_account_name
    5_API_SECRET_KEY:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 5_api_secret_key
    6_ACCOUNT_NAME:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 6_account_name
    6_API_SECRET_KEY:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 6_api_secret_key
    7_ACCOUNT_NAME:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 7_account_name
    7_API_SECRET_KEY:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 7_api_secret_key
    8_ACCOUNT_NAME:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 8_account_name
    8_API_SECRET_KEY:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 8_api_secret_key
    9_ACCOUNT_NAME:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 9_account_name
    9_API_SECRET_KEY:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 9_api_secret_key
    10_ACCOUNT_NAME:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 10_account_name
    10_API_SECRET_KEY:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 10_api_secret_key
    11_ACCOUNT_NAME:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 11_account_name
    11_API_SECRET_KEY:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 11_api_secret_key
    12_ACCOUNT_NAME:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 12_account_name
    12_API_SECRET_KEY:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 12_api_secret_key
    13_ACCOUNT_NAME:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 13_account_name
    13_API_SECRET_KEY:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 13_api_secret_key
    14_ACCOUNT_NAME:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 14_account_name
    14_API_SECRET_KEY:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 14_api_secret_key
    15_ACCOUNT_NAME:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 15_account_name
    15_API_SECRET_KEY:
      secretKeyRef: swh-cassandra-objstorage-config
      secretKeyName: 15_api_secret_key

storage_replayer:
  enabled: true

  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: "swh/replayer"
            operator: In
            values:
            - "true"
  journalBrokers:
    hosts:
      - kafka1.internal.softwareheritage.org:9094
      - kafka2.internal.softwareheritage.org:9094
      - kafka3.internal.softwareheritage.org:9094
      - kafka4.internal.softwareheritage.org:9094
    user: swh-cassandra-prod
    groupIdName: cassandra
  storageConfigurationRef: cassandraReplayerStorageConfiguration
  error_reporter:
    host: redis-cassandra-replayers.redis
    port: 6379
    db: 1
  deployments:
    content:
      objects:
        - content
      privileged: true
      requestedCpu: 425m
      requestedMemory: 200Mi
      autoScaling:
        maxReplicaCount: 64
    directory:
      objects:
        - directory
      privileged: true
      batchSize: 250
      # Full replay
      requestedCpu: 500m
      requestedMemory: 250Mi
      # Follow up consumption
      # requestedMemory: 100Mi
      autoScaling:
        maxReplicaCount: 10
    extid:
      objects:
        - extid
      privileged: true
      batchSize: 1000
      # Full replay
      # requestedCpu: 400m
      requestedMemory: 200Mi
      #Follow up consumption
      requestedCpu: 50m
      autoScaling:
        maxReplicaCount: 5
    metadata:
      objects:
        - metadata_authority
        - metadata_fetcher
      privileged: true
      # follow up consumption
      requestedCpu: 50m
      requestedMemory: 100Mi
      autoScaling:
        maxReplicaCount: 5
    raw-extrinsic-metadata:
      objects:
        - raw_extrinsic_metadata
      privileged: true
      batchSize: 250
      # Full replay
      requestedCpu: 400m
      requestedMemory: 200Mi
      # follow up consumption
      # requestedCpu: 50m
      autoScaling:
        maxReplicaCount: 5
    origin:
      objects:
        - origin
      privileged: true
      batchSize: 1000
      # Full replay
      # requestedCpu: 400m
      requestedMemory: 200Mi
      #Follow up consumption
      requestedCpu: 50m
      autoScaling:
        maxReplicaCount: 5
    origin-visit:
      objects:
        - origin_visit
      privileged: true
      batchSize: 1000
      # Full replay
      requestedCpu: 400m
      requestedMemory: 400Mi
      #Follow up consumption
      # requestedCpu: 100m
      # requestedMemory: 100Mi
      autoScaling:
        maxReplicaCount: 5
    origin-visit-status:
      objects:
        - origin_visit_status
      privileged: true
      batchSize: 1000
      # Full replay
      requestedCpu: 500m
      requestedMemory: 300Mi
      #Follow up consumption
      # requestedCpu: 55m
      # requestedMemory: 200Mi
      autoScaling:
        maxReplicaCount: 5
    release:
      objects:
        - release
      privileged: true
      batchSize: 1000
      # Full replay
      # requestedCpu: 600m
      requestedMemory: 300Mi
      # follow up consumption
      requestedCpu: 50m
      autoScaling:
        maxReplicaCount: 5
    revision:
      objects:
        - revision
      batchSize: 1000
      privileged: true
      # Full replay
      # requestedCpu: 750m
      # requestedMemory: 750Mi
      # follow up consumption
      requestedCpu: 50m
      requestedMemory: 400Mi
      autoScaling:
        maxReplicaCount: 5
    skipped-content:
      objects:
        - skipped_content
      privileged: true
      batchSize: 100
      # Full replay
      # requestedCpu: 300m
      requestedMemory: 400Mi
      # follow up consumption
      requestedCpu: 50m
      autoScaling:
        maxReplicaCount: 5
    snapshot:
      objects:
        - snapshot
      privileged: true
      batchSize: 250
      # Full replay
      # requestedCpu: 400m
      requestedMemory: 250Mi
      # follow up consumption
      requestedCpu: 80m
      autoScaling:
        maxReplicaCount: 5

storage:
  enabled: true
  replicas: 2
  requestedCpu: 500m
  requestedMemory: 500Mi
  storageConfigurationRef: cassandraStorageConfiguration

postgresqlWebConfiguration:
  host: db.internal.softwareheritage.org
  port: 5432
  db: swh-web
  user: swh-web
  pass: ${POSTGRESQL_PASSWORD}
  secrets:
    POSTGRESQL_PASSWORD:
      secretKeyRef: swh-postgresql-web-secrets
      secretKeyName: postgres-swh-web-password

djangoWebConfiguration:
  secrets:
    DJANGO_SECRET_KEY:
      secretKeyRef: swh-webapp-django-secret
      secretKeyName: webapp-django-secret-key

web:
  enabled: true
  logLevel: INFO
  requestedCpu: 500m
  requestedMemory: 500Mi
  autoScaling:
    minReplicaCount: 2
    maxReplicaCount: 4
    cpuPercentageUsage: 50
  hosts:
    - webapp-cassandra.internal.softwareheritage.org
  ingress:
    enabled: true
    secretName: swh-web-crt
    extraAnnotations:
      cert-manager.io/cluster-issuer: letsencrypt-production-gandi
      kubernetes.io/ingress.class: nginx
      kubernetes.io/tls-acme: "true"
      nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    tlsEnabled: true
    whitelistSourceRangeRef: internalNetworkRanges
    endpoints:
      default:
        paths:
          - path: /
          - path: /static
            port: 80
        extraWhitelistSourceRange:
          - 192.168.50.0/24 # for blackbox monitoring
          - 192.168.101.0/24 # vpn network

  databaseConfigurationRef: postgresqlWebConfiguration
  searchConfigurationRef: remoteSearchConfiguration
  schedulerConfigurationRef: remoteSchedulerConfiguration
  storageConfigurationRef: remoteStorageConfiguration
  vaultConfigurationRef: remoteVaultConfiguration
  indexerStorageConfigurationRef: remoteIndexerStorageConfiguration
  countersConfigurationRef: remoteCountersConfiguration
  djangoConfigurationRef: djangoWebConfiguration
  giveConfigurationRef: giveConfiguration
  throttlingConfigurationRef: webThrottling
  addForgeNowConfigurationRef: addForgeNowConfiguration
  extraConfig:
    keycloak:
      server_url: https://auth.softwareheritage.org/auth/
      realm_name: SoftwareHeritage
    search_config:
      metadata_backend: swh-search
    content_display_max_size: 5242880
    history_counters_url: http://counters1.internal.softwareheritage.org:5011/counters_history/history.json#
    es_workers_index_url: http://esnode1.internal.softwareheritage.org:9200/swh_workers-*
    swh_extra_django_apps:
      - swh.web.add_forge_now
      - swh.web.archive_coverage
      - swh.web.badges
      - swh.web.banners
      - swh.web.deposit
      - swh.web.inbound_email
      - swh.web.jslicenses
      - swh.web.mailmap
      - swh.web.metrics
      - swh.web.save_code_now
      - swh.web.save_origin_webhooks
      - swh.web.vault
    give:
      public_key: ${GIVE_PUBLIC_KEY}
      token: ${GIVE_PRIVATE_TOKEN}

graphql:
  enabled: true
  replicas: 1
  storageConfigurationRef: localRpcROStorageConfiguration
  searchConfigurationRef: remoteSearchConfiguration
  introspection: yes
  hosts:
    - webapp-cassandra.internal.softwareheritage.org
  ingress:
    enabled: true
    whitelistSourceRangeRef: internalNetworkRanges
    endpoints:
      default:
        extraWhitelistSourceRange:
          # vpn network
          - 192.168.101.0/24
        paths:
          - path: /graphql/
  gunicorn:
    threads: 4
    workers: 2
    timeout: 3600
  auth:
    enabled: false
    server: https://auth.softwareheritage.org/auth/
    realm: SoftwareHeritage
    client: swh-web
    cacheUrl: memcached://memcached:11211
  maxRawContentSize: 10000

toolbox:
  enabled: true
  configs:
    scrubber-storage:
      scrubberDbConfigurationRef: postgresqlScrubberConfiguration
      storageConfigurationRef: scrubberROStorageConfiguration

scrubber:
  enabled: true
  scrubberDatabaseConfigurationRef: postgresqlScrubberConfiguration
  priorityClassName: background-workload
  storageChecker:
    enabled: true
    storageConfigurationRef: scrubberROStorageConfiguration
    deployments:
      directory-references:
        configName: storage-cassandra-references-directory
        object: directory
        replicas: 4
        requestedCpu: 400m
        requestedMemory: 200Mi
      directory-hashes:
        configName: storage-cassandra-hashes-directory
        object: directory
        replicas: 4
        requestedCpu: 400m
        requestedMemory: 200Mi
      release-references:
        # until https://gitlab.softwareheritage.org/swh/devel/swh-scrubber/-/issues/4699 fix
        enabled: false
        configName: storage-cassandra-references-release
        object: release
        replicas: 4
      release-hashes:
        # until https://gitlab.softwareheritage.org/swh/devel/swh-scrubber/-/issues/4699 fix
        enabled: false
        configName: storage-cassandra-hashes-release
        object: release
        replicas: 4
      revision-references:
        configName: storage-cassandra-references-revision
        object: revision
        requestedCpu: 500m
        requestedMemory: 200Mi
      revision-hashes:
        configName: storage-cassandra-hashes-revision
        object: revision
        requestedCpu: 500m
        requestedMemory: 200Mi
      snapshot-references:
        configName: storage-cassandra-references-snapshot
        replicas: 4
        object: snapshot
        requestedCpu: 650m
        requestedMemory: 500Mi
      snapshot-hashes:
        # until https://gitlab.softwareheritage.org/swh/devel/swh-scrubber/-/issues/4699 fix
        enabled: false
        configName: storage-cassandra-hashes-snapshot
        replicas: 4
        object: snapshot
        requestedCpu: 650m
        requestedMemory: 500Mi
