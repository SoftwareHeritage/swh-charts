namespace: swh-cassandra

cassandraROStorage:
  cls: cassandra
  cassandraSeedsRef: cassandraSeeds
  keyspace: swh
  initKeyspace: false
  consistencyLevel: LOCAL_QUORUM
  authProvider:
    cls: cassandra.auth.PlainTextAuthProvider
    username: swh-ro
    password: ${CASSANDRA_PASSWORD}
  secrets:
    CASSANDRA_PASSWORD:
      secretKeyRef: common-secrets
      secretKeyName: cassandra-swh-ro-password

cassandraChecksROStorage:
  cls: cassandra
  cassandraSeedsRef: cassandraSeeds
  keyspace: swh
  initKeyspace: false
  consistencyLevel: LOCAL_QUORUM
  authProvider:
    cls: cassandra.auth.PlainTextAuthProvider
    username: swh-ro
    password: ${CASSANDRA_PASSWORD}
  specificOptions:
    directory_entries_insert_algo: batch
    objstorage:
      cls: noop
  secrets:
    CASSANDRA_PASSWORD:
      secretKeyRef: common-secrets
      secretKeyName: cassandra-swh-ro-password

cassandraReplayerStorageConfiguration:
  storageConfigurationRef: cassandraStorage
  objstorageConfigurationRef: noopObjstorageConfiguration

cassandraStorageConfiguration:
  storageConfigurationRef: cassandraStorage
  objstorageConfigurationRef: roObjstorageConfiguration

cassandraReadOnlyStorageConfiguration:
  storageConfigurationRef: cassandraROStorage
  objstorageConfigurationRef: roObjstorageConfiguration

scrubberROStorageConfiguration:
  storageConfigurationRef: cassandraROStorage

scrubberObjstorageJournalClientConfiguration:
  cls: kafka
  brokersConfigurationRef: internalSecuredKafkaBrokers
  group_id: swh-archive-prod-objstoragechecker
  sasl.mechanism: SCRAM-SHA-512
  security.protocol: SASL_SSL
  sasl.username: ${BROKER_USER}
  sasl.password: ${BROKER_USER_PASSWORD}
  prefix: swh.journal.objects
  message.max.bytes: "524288000"
  secrets:
    BROKER_USER:
      secretKeyRef: swh-archive-broker-secret
      secretKeyName: BROKER_USER
    BROKER_USER_PASSWORD:
      secretKeyRef: swh-archive-broker-secret
      secretKeyName: BROKER_USER_PASSWORD

# (Not so) readonly (namespace local) storage
# TODO: Use a true read-only storage
rpcROStorageService:
  cls: remote
  url: http://storage-cassandra-read-only-rpc-ingress

remoteStorageConfiguration:
  cls: remote
  url: http://storage-azure-read-only-rpc-ingress-swh-cassandra

rpcROStorageCassandraWithRetryConfiguration:
  pipelineStepsRef: retryStoragePipelineSteps
  storageConfigurationRef: rpcROStorageService

# Replayer kafka -> cassandra will be disabled once we migrate to cassandra
# as the main backend.
storageReplayer:
  enabled: false
  journalClientConfigurationRef: storageReplayerJournalClientConfiguration
  storageConfigurationRef: cassandraReplayerStorageConfiguration
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: "swh/replayer"
            operator: In
            values:
            - "true"
  error_reporter:
    host: redis-cassandra-replayers.redis
    port: 6379
    db: 1
  deployments:
    content:
      journalClientOverrides:
        group_id: swh-cassandra-prod-cassandra-replayer-content
        object_types:
          - content
      requestedCpu: 425m
      requestedMemory: 200Mi
      autoScaling:
        maxReplicaCount: 64
    directory:
      journalClientOverrides:
        group_id: swh-cassandra-prod-cassandra-replayer-directory
        object_types:
          - directory
        batch_size: 250
      # Full replay
      requestedCpu: 500m
      requestedMemory: 250Mi
      # Follow up consumption
      # requestedMemory: 100Mi
      autoScaling:
        maxReplicaCount: 10
    extid:
      journalClientOverrides:
        group_id: swh-cassandra-prod-cassandra-replayer-extid
        object_types:
          - extid
        batch_size: 1000
      # Full replay
      # requestedCpu: 400m
      requestedMemory: 200Mi
      # Follow up consumption
      requestedCpu: 50m
      autoScaling:
        maxReplicaCount: 5
    metadata:
      journalClientOverrides:
        group_id: swh-cassandra-prod-cassandra-replayer-metadata
        object_types:
          - metadata_authority
          - metadata_fetcher
      # follow up consumption
      requestedCpu: 50m
      requestedMemory: 100Mi
      autoScaling:
        maxReplicaCount: 5
    raw-extrinsic-metadata:
      journalClientOverrides:
        group_id: swh-cassandra-prod-cassandra-replayer-raw-extrinsic-metadata
        object_types:
        - raw_extrinsic_metadata
        batch_size: 250
      # Full replay
      requestedCpu: 400m
      requestedMemory: 200Mi
      # follow up consumption
      # requestedCpu: 50m
      autoScaling:
        maxReplicaCount: 5
    origin:
      journalClientOverrides:
        group_id: swh-cassandra-prod-cassandra-replayer-origin
        object_types:
          - origin
        batch_size: 1000
      # Full replay
      # requestedCpu: 400m
      requestedMemory: 200Mi
      # Follow up consumption
      requestedCpu: 50m
      autoScaling:
        maxReplicaCount: 5
    origin-visit:
      journalClientOverrides:
        group_id: swh-cassandra-prod-cassandra-replayer-origin-visit
        object_types:
          - origin_visit
        batch_size: 1000
      # Full replay
      requestedCpu: 400m
      requestedMemory: 400Mi
      # Follow up consumption
      # requestedCpu: 100m
      # requestedMemory: 100Mi
      autoScaling:
        maxReplicaCount: 5
    origin-visit-status:
      journalClientOverrides:
        group_id: swh-cassandra-prod-cassandra-replayer-origin-visit-status
        object_types:
          - origin_visit_status
        batch_size: 1000
      # Full replay
      requestedCpu: 500m
      requestedMemory: 300Mi
      # Follow up consumption
      # requestedCpu: 55m
      # requestedMemory: 200Mi
      autoScaling:
        maxReplicaCount: 5
    release:
      journalClientOverrides:
        group_id: swh-cassandra-prod-cassandra-replayer-release
        object_types:
          - release
        batch_size: 1000
      # Full replay
      # requestedCpu: 600m
      requestedMemory: 300Mi
      # follow up consumption
      requestedCpu: 50m
      autoScaling:
        maxReplicaCount: 5
    revision:
      journalClientOverrides:
        group_id: swh-cassandra-prod-cassandra-replayer-revision
        object_types:
          - revision
        batch_size: 1000
      # Full replay
      # requestedCpu: 750m
      # requestedMemory: 750Mi
      # follow up consumption
      requestedCpu: 50m
      requestedMemory: 400Mi
      autoScaling:
        maxReplicaCount: 5
    skipped-content:
      journalClientOverrides:
        group_id: swh-cassandra-prod-cassandra-replayer-skipped-content
        object_types:
          - skipped_content
        batch_size: 100
      # Full replay
      # requestedCpu: 300m
      requestedMemory: 400Mi
      # follow up consumption
      requestedCpu: 50m
      autoScaling:
        maxReplicaCount: 5
    snapshot:
      journalClientOverrides:
        group_id: swh-cassandra-prod-cassandra-replayer-snapshot
        object_types:
          - snapshot
        batch_size: 250
      # Full replay
      # requestedCpu: 400m
      requestedMemory: 250Mi
      # follow up consumption
      requestedCpu: 80m
      autoScaling:
        maxReplicaCount: 5

readOnlyCassandraStorageConfiguration:
  pipelineStepsRef: maskingStoragePipelineSteps
  storageConfigurationRef: cassandraROStorage
  objstorageConfigurationRef: roObjstorageBestEffortConfiguration

storage:
  enabled: true
  gunicorn:
    workers: 2
    threads: 4
    timeout: 3600
  deployments:
    # public facing instance (behind authentication)
    cassandra-readonly:
      enabled: true
      autoScaling:
        minReplicaCount: 1
        maxReplicaCount: 3
        cpuPercentageUsage: 150
      requestedCpu: 500m
      requestedMemory: 1.5Gi
      storageConfigurationRef: cassandraReadOnlyStorageConfiguration
      hosts:
        - storage-cassandra-ro.softwareheritage.org
      ingress:
        enabled: true
        tlsEnabled: false
        extraAnnotations:
          nginx.ingress.kubernetes.io/proxy-body-size: 4G
          nginx.ingress.kubernetes.io/proxy-buffering: "on"
          nginx.ingress.kubernetes.io/client-body-buffer-size: 128K
        endpoints:
          default:
            paths:
              - path: /
            authentication: swh-cassandra/ingress-storage-cassandra-ro-auth-secrets
    # Use cassandra readonly instance
    cassandra-readonly-internal:
      enabled: true
      autoScaling:
        minReplicaCount: 1
        maxReplicaCount: 3
        cpuPercentageUsage: 150
      requestedCpu: 500m
      requestedMemory: 1.5Gi
      storageConfigurationRef: cassandraReadOnlyStorageConfiguration
      hosts:
        - storage-cassandra-read-only-rpc-ingress
      ingress:
        enabled: true
        tlsEnabled: false
        extraAnnotations:
          nginx.ingress.kubernetes.io/proxy-body-size: 4G
          nginx.ingress.kubernetes.io/proxy-buffering: "on"
          nginx.ingress.kubernetes.io/client-body-buffer-size: 128K
        endpoints:
          default:
            paths:
              - path: /
    cassandra-azure-readonly:
      enabled: true
      autoScaling:
        minReplicaCount: 2
        maxReplicaCount: 10
        cpuPercentageUsage: 30
      requestedCpu: 500m
      requestedMemory: 1.5Gi
      storageConfigurationRef: readOnlyCassandraStorageConfiguration
      hosts:
        - storage-azure-read-only-rpc-ingress-swh-cassandra
        - storage-cassandra-ro.internal.softwareheritage.org
      ingress:
        enabled: true
        whitelistSourceRangeRef: internalNetworkRanges
        extraAnnotations:
          nginx.ingress.kubernetes.io/proxy-body-size: 4G
          nginx.ingress.kubernetes.io/proxy-buffering: "on"
        endpoints:
          default:
            paths:
              - path: /
            extraWhitelistSourceRange:
              # vpn network
              - 192.168.101.0/24
      gunicorn:
        threads: 4
        workers: 8
    # Future main instance used by the writing workload (loaders)
    cassandra-winery:
      # TODO: Enable when writing services has been migrated and we also decommission
      # the equivalent one in the namespace swh
      enabled: true
      requestedCpu: 1000m
      requestedMemory: 2Gi
      autoScaling:
        minReplicaCount: 4
        maxReplicaCount: 10
        cpuPercentageUsage: 50
      gunicorn:
        workers: 16
        threads: 1
        timeout: 3600
      storageConfigurationRef: rwStorageCassandraWithWineryObjstorageConfiguration
      dnsConfigurationRef: dnsConfiguration
      hosts:
        - storage-rw-cassandra-ingress-swh-cassandra
        - storage-rw-cassandra-saam-ingress-swh-cassandra
      ingress:
        enabled: true
        whitelistSourceRangeRef: internalNetworkRanges
        extraAnnotations:
          nginx.ingress.kubernetes.io/proxy-body-size: 4G
          nginx.ingress.kubernetes.io/proxy-buffering: "on"
          nginx.ingress.kubernetes.io/client-body-buffer-size: 128K
          nginx.ingress.kubernetes.io/proxy-connect-timeout: "90"
          nginx.ingress.kubernetes.io/proxy-send-timeout: "90"
          nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
        endpoints:
          default:
            paths:
              - path: /
      cronjobs:
        create-object-reference-partitions:
          # Job only relevant for postgresql backends
          enabled: false

postgresqlWebConfiguration:
  host: postgresql-web-rw.internal.softwareheritage.org
  port: 5432
  db: swh-web
  user: swh-web
  pass: ${POSTGRESQL_PASSWORD}
  secrets:
    POSTGRESQL_PASSWORD:
      secretKeyRef: swh-postgresql-web-secrets
      secretKeyName: postgres-swh-web-password

historyCountersUrl: http://counters-rpc-ingress-swh-cassandra/counters_history/history.json#

web:
  enabled: true
  logLevel: INFO
  deployments:
    # Main instance serving archive.softwareheritage.org
    archive:
      gunicorn:
        workers: 8
        threads: 2
        timeout: 3600
      autoScaling:
        type: keda
        minReplicaCount: 8
        maxReplicaCount: 10
        threshold: 10
      metricsScrapingEnabled: true
      requestedCpu: 500m
      requestedMemory: 6Gi
      cronJobs:
        refreshSCNStatus:
          enabled: false
          cron: "*/2 * * * *"
          command:
            - "refresh_savecodenow_statuses"
          concurrencyPolicy: Forbid
          priorityClassName: frontend-rpc-workload
        syncMaskingMailmaps:
          enabled: true
          command:
            - "sync_masking_mailmaps"
            - "--perform"
            - "service=syncmaskingmailmaps"
          cron: "15 *  * * *"
          concurrencyPolicy: Forbid
          configurationRef: postgresqlSyncMaskingProxyMailmapsConfiguration
          priorityClassName: frontend-rpc-workload
          pgService: true
      hosts:
        - archive.softwareheritage.org
        - base.softwareheritage.org
        - archive.internal.softwareheritage.org
        - archive-dynamic.internal.softwareheritage.org
      ingress:
        enabled: true
        secretName: swh-web-archive-crt
        extraAnnotations:
          kubernetes.io/ingress.class: nginx
        tlsExtraAnnotations:
          cert-manager.io/cluster-issuer: letsencrypt-production-gandi
          kubernetes.io/tls-acme: "true"
          nginx.ingress.kubernetes.io/ssl-redirect: "true"
        endpoints:
          default:
            paths:
              - path: /
          static:
            extraAnnotations:
              nginx.ingress.kubernetes.io/use-regex: "true"
              nginx.ingress.kubernetes.io/rewrite-target: /static/$2
            paths:
              - path: /()(robots.txt)$
                pathType: ImplementationSpecific
                port: 80
              - path: /static(/|$)(.*)
                pathType: ImplementationSpecific
                port: 80
          authenticated:
            paths:
              - path: /api/1/entity/
              - path: /api/1/content/[^/]+/symbol/
            # auth-file with authentication
            authentication: swh-cassandra/web-auth-secrets
      databaseConfigurationRef: postgresqlWebConfiguration
      searchConfigurationRef: remoteSearchConfiguration
      schedulerConfigurationRef: remoteSchedulerConfiguration
      storageConfigurationRef: remoteStorageConfiguration
      vaultConfigurationRef: remoteVaultConfiguration
      indexerStorageConfigurationRef: remoteReadOnlyIndexerStorageConfiguration
      countersConfigurationRef: remoteCountersConfiguration
      historyCountersUrlRef: historyCountersUrl
      esWorkersIndexUrlRef: esWorkersIndexUrl
      djangoConfigurationRef: djangoWebConfiguration
      giveConfigurationRef: giveConfiguration
      throttlingConfigurationRef: webThrottling
      addForgeNowConfigurationRef: addForgeNowConfiguration
      webhooksConfigurationRef: webhooksConfiguration
      depositConfigurationRef: depositConfiguration
      keycloakConfigurationRef: keycloakConfiguration
      inboundEmailConfigurationRef: inboundEmailConfiguration
      provenanceConfigurationRef: provenanceConfiguration
      djangoAppsRef: webDjangoApps
      graphConfigurationRef: webGraphConfiguration
      extraConfig:
        save_code_now_webhook_secret: ${WEBHOOKS_SECRET}
        search_config:
          metadata_backend: swh-search
        inbound_email:
          shared_key: ${INBOUND_EMAIL_SHARED_KEY}
        content_display_max_size: 5242880
        give:
          public_key: ${GIVE_PUBLIC_KEY}
          token: ${GIVE_PRIVATE_TOKEN}
        matomo:
          url: https://piwik.inria.fr/
          site_id: 59

    cassandra:
      enabled: false
      metricsScrapingEnabled: false
      requestedCpu: 500m
      requestedMemory: 500Mi
      autoScaling:
        minReplicaCount: 2
        maxReplicaCount: 4
        cpuPercentageUsage: 50
      gunicorn:
        timeout: 3600
      hosts:
        - webapp-cassandra.internal.softwareheritage.org
      ingress:
        enabled: true
        secretName: swh-web-crt
        extraAnnotations:
          cert-manager.io/cluster-issuer: letsencrypt-production-gandi
          kubernetes.io/ingress.class: nginx
          kubernetes.io/tls-acme: "true"
          nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
        tlsEnabled: true
        whitelistSourceRangeRef: internalNetworkRanges
        endpoints:
          default:
            paths:
              - path: /
            extraWhitelistSourceRange:
              - 192.168.50.0/24 # for blackbox monitoring
              - 192.168.101.0/24 # vpn network
          static:
            extraAnnotations:
              nginx.ingress.kubernetes.io/use-regex: "true"
              nginx.ingress.kubernetes.io/rewrite-target: /static/$2
            paths:
              - path: /()(robots.txt)$
                pathType: ImplementationSpecific
                port: 80
              - path: /static(/|$)(.*)
                pathType: ImplementationSpecific
                port: 80
            extraWhitelistSourceRange:
              - 192.168.50.0/24 # for blackbox monitoring
              - 192.168.101.0/24 # vpn network
      databaseConfigurationRef: postgresqlWebConfiguration
      searchConfigurationRef: remoteSearchConfiguration
      schedulerConfigurationRef: remoteSchedulerConfiguration
      storageConfigurationRef: rpcROStorageService
      vaultConfigurationRef: remoteVaultConfiguration
      indexerStorageConfigurationRef: remoteReadOnlyIndexerStorageConfiguration
      countersConfigurationRef: remoteCountersConfiguration
      historyCountersUrlRef: historyCountersUrl
      esWorkersIndexUrlRef: esWorkersIndexUrl
      djangoConfigurationRef: djangoWebConfiguration
      giveConfigurationRef: giveConfiguration
      throttlingConfigurationRef: webThrottling
      addForgeNowConfigurationRef: addForgeNowConfiguration
      depositConfigurationRef: depositConfiguration
      keycloakConfigurationRef: keycloakConfiguration
      inboundEmailConfigurationRef: inboundEmailConfiguration
      provenanceConfigurationRef: provenanceConfiguration
      djangoAppsRef: webDjangoApps
      graphConfigurationRef: webGraphConfiguration
      extraConfig:
        search_config:
          metadata_backend: swh-search
        inbound_email:
          shared_key: ${INBOUND_EMAIL_SHARED_KEY}
        content_display_max_size: 5242880
        give:
          public_key: ${GIVE_PUBLIC_KEY}
          token: ${GIVE_PRIVATE_TOKEN}
    # webhooks instance to serve svix requests
    webhooks:
      # The ingress accepts only 10 concurrent requests so the number of workers
      # can be configured accordingly with a margin for monitoring probes
      gunicorn:
        workers: 2
        threads: 11
        timeout: 60
      replicas: 2
      metricsScrapingEnabled: true
      requestedCpu: 200m
      requestedMemory: 7Gi
      hosts:
        - archive.softwareheritage.org
        - archive.internal.softwareheritage.org
      ingress:
        enabled: true
        secretName: swh-web-archive-crt
        extraAnnotations:
          kubernetes.io/ingress.class: nginx
        tlsExtraAnnotations:
          cert-manager.io/cluster-issuer: letsencrypt-production-gandi
          kubernetes.io/tls-acme: "true"
          nginx.ingress.kubernetes.io/ssl-redirect: "true"
        endpoints:
          webhooks:
            extraAnnotations:
              # The number of connections to allow is estimated to ~1.5x the number
              # of webhook journal client for the scn endpoint
              # Another estimated could be around 1 connection per ~15 origin_visits_status/s
              # Adapt the replicas and workers if this values is changed
              # During the backup, some request took more time than expected so the
              # limits need to be increase to avoid to many rejects
              nginx.ingress.kubernetes.io/limit-connections: "20"
            tlsEnabled: true
            paths:
              - path: /save/origin/visit/webhook
            extraWhitelistSourceRange:
              - 192.168.100.0/24
              # moma access due to the absence of TLS termination on internal ingresses
              # svix-server endpoints requires TLS connections
              - 128.93.166.2/32
      databaseConfigurationRef: postgresqlWebConfiguration
      searchConfigurationRef: remoteSearchConfiguration
      schedulerConfigurationRef: remoteSchedulerConfiguration
      storageConfigurationRef: remoteStorageConfiguration
      vaultConfigurationRef: remoteVaultConfiguration
      indexerStorageConfigurationRef: remoteReadOnlyIndexerStorageConfiguration
      countersConfigurationRef: remoteCountersConfiguration
      historyCountersUrlRef: historyCountersUrl
      esWorkersIndexUrlRef: esWorkersIndexUrl
      djangoConfigurationRef: djangoWebConfiguration
      giveConfigurationRef: giveConfiguration
      throttlingConfigurationRef: webThrottling
      addForgeNowConfigurationRef: addForgeNowConfiguration
      webhooksConfigurationRef: webhooksConfiguration
      depositConfigurationRef: depositConfiguration
      keycloakConfigurationRef: keycloakConfiguration
      inboundEmailConfigurationRef: inboundEmailConfiguration
      djangoAppsRef: webDjangoApps

      extraConfig:
        save_code_now_webhook_secret: ${WEBHOOKS_SECRET}
        search_config:
          metadata_backend: swh-search
        inbound_email:
          shared_key: ${INBOUND_EMAIL_SHARED_KEY}
        content_display_max_size: 5242880
        give:
          public_key: ${GIVE_PUBLIC_KEY}
          token: ${GIVE_PRIVATE_TOKEN}
        matomo:
          url: https://piwik.inria.fr/
          site_id: 59

graphql:
  enabled: true
  deployments:
    cassandra:
      replicas: 1
      gunicorn:
        threads: 4
        workers: 2
        timeout: 3600
      storageConfigurationRef: rpcROStorageCassandraWithRetryConfiguration
      searchConfigurationRef: remoteSearchConfiguration
      introspection: yes
      hosts:
        - webapp-cassandra.internal.softwareheritage.org
      ingress:
        enabled: true
        whitelistSourceRangeRef: internalNetworkRanges
        extraAnnotations:
          nginx.ingress.kubernetes.io/rewrite-target: /
        endpoints:
          default:
            extraWhitelistSourceRange:
              # vpn network
              - 192.168.101.0/24
              - 192.168.50.0/24
            paths:
              - path: /graphql/
      auth:
        enabled: false
        server: https://auth.softwareheritage.org/auth/
        realm: SoftwareHeritage
        client: swh-web
        cacheUrl: memcached://memcached:11211
      maxRawContentSize: 10000
    # Main instance to serve https://archive.softwaheritage.org/graphql/
    archive:
      gunicorn:
        workers: 2
        threads: 4
        timeout: 3600
      replicas: 2
      storageConfigurationRef: rpcROStorageCassandraWithRetryConfiguration
      searchConfigurationRef: remoteSearchConfiguration
      introspection: yes
      hosts:
        - archive.softwareheritage.org
      ingress:
        enabled: true
        extraAnnotations:
          nginx.ingress.kubernetes.io/rewrite-target: /
        endpoints:
          default:
            paths:
              - path: /graphql/
      auth:
        enabled: true
        server: https://auth.softwareheritage.org/auth/
        realm: SoftwareHeritage
        client: swh-web
        cacheUrl: memcached://memcached:11211
      maxRawContentSize: 10000

toolbox:
  enabled: true
  configs:
    indexer-storage:
      moduleName: indexer
      moduleConfigKey: indexer_storage
      indexerDbConfigurationRef: postgresqlIndexerStorageConfiguration
    scheduler:
      schedulerDbConfigurationRef: postgresqlSchedulerConfiguration
      celeryConfigurationRef: producerCeleryConfiguration
    scrubber-journal:
      scrubberDbConfigurationRef: postgresqlScrubberConfiguration
      journalClientConfigurationRef: authenticatedJournalClientConfiguration
    scrubber-storage:
      moduleName: scrubber
      scrubberDbConfigurationRef: postgresqlScrubberConfiguration
      storageConfigurationRef: scrubberROStorageConfiguration
    vault:
      vaultDbConfigurationRef: postgresqlVaultConfiguration
    webhooks:
      webhooksConfigurationRef: svixConfiguration

scrubber:
  enabled: true
  scrubberDatabaseConfigurationRef: postgresqlScrubberConfiguration
  priorityClassName: background-workload
  objstorageChecker:
    enabled: true
    storageConfigurationRef: scrubberROStorageConfiguration
    journalClientConfigurationRef: scrubberObjstorageJournalClientConfiguration
    deployments:
      banco:
        objstorageConfigurationRef: remoteBancoReadOnlyObjstorageConfiguration
        configName: objstorage-banco-content
        replicas: 4
        requestedCpu: 400m
        requestedMemory: 200Mi
        backend:
          check: true
          migrate: false
          config:
            name: objstorage-banco-content
            objectType: content
            backend: objstorage
            checkHashes: true
            checkReferences: false
            nbPartitions: 65536
      saam:
        objstorageConfigurationRef: remoteSaamReadOnlyObjstorageConfiguration
        configName: objstorage-saam-content
        replicas: 4
        requestedCpu: 400m
        requestedMemory: 200Mi
        backend:
          check: true
          migrate: false
          config:
            name: objstorage-saam-content
            objectType: content
            backend: objstorage
            checkHashes: true
            checkReferences: false
            nbPartitions: 65536
  journalChecker:
    enabled: true
    journalClientConfigurationRef: authenticatedJournalClientConfiguration
    deployments:
      directory:
        # Disabled until a fix or workaroud for swh/devel/swh-scrubber#4698
        # is available
        enabled: false
        configName: journal-checker-directory
        journalClientOverrides:
          batch_size: 100
          on_eof: restart
        object: directory
        replicas: 2
        requestedCpu: 1
        requestedMemory: 200Mi
      release:
        configName: journal-checker-release
        journalClientOverrides:
          batch_size: 200
          privileged: true
          on_eof: restart
        object: release
        replicas: 1
        requestedCpu: 1
        requestedMemory: 200Mi
      revision:
        configName: journal-checker-revision
        journalClientOverrides:
          privileged: true
          on_eof: restart
        object: revision
        replicas: 2
        requestedCpu: 1
        requestedMemory: 250Mi
      snapshot:
        configName: journal-checker-snapshot
        object: snapshot
        journalClientOverrides:
          on_eof: restart
        replicas: 2
        requestedCpu: 1
        requestedMemory: 250Mi
  storageChecker:
    enabled: false
    storageConfigurationRef: scrubberROStorageConfiguration
    deployments:
      directory-references:
        configName: storage-cassandra-references-directory
        object: directory
        replicas: 8
        requestedCpu: 400m
        requestedMemory: 200Mi
      directory-hashes:
        # until https://gitlab.softwareheritage.org/swh/devel/swh-scrubber/-/issues/4699 fix
        # see also https://gitlab.softwareheritage.org/swh/infra/sysadm-environment/-/issues/5310
        enabled: false
        configName: storage-cassandra-hashes-directory
        object: directory
        replicas: 8
        requestedCpu: 400m
        requestedMemory: 200Mi
      release-references:
        # until https://gitlab.softwareheritage.org/swh/devel/swh-scrubber/-/issues/4699 fix
        enabled: false
        configName: storage-cassandra-references-release
        object: release
        replicas: 4
      release-hashes:
        # until https://gitlab.softwareheritage.org/swh/devel/swh-scrubber/-/issues/4699 fix
        enabled: false
        configName: storage-cassandra-hashes-release
        object: release
        replicas: 4
      revision-references:
        # until https://gitlab.softwareheritage.org/swh/devel/swh-scrubber/-/issues/4699 fix
        enabled: false
        configName: storage-cassandra-references-revision
        object: revision
        requestedCpu: 500m
        requestedMemory: 200Mi
      revision-hashes:
        # until https://gitlab.softwareheritage.org/swh/devel/swh-scrubber/-/issues/4699 fix
        enabled: false
        configName: storage-cassandra-hashes-revision
        object: revision
        requestedCpu: 500m
        requestedMemory: 200Mi
      snapshot-references:
        # until https://gitlab.softwareheritage.org/swh/devel/swh-scrubber/-/issues/4699 fix
        enabled: false
        configName: storage-cassandra-references-snapshot
        replicas: 4
        object: snapshot
        requestedCpu: 650m
        requestedMemory: 500Mi
      snapshot-hashes:
        # until https://gitlab.softwareheritage.org/swh/devel/swh-scrubber/-/issues/4699 fix
        enabled: false
        configName: storage-cassandra-hashes-snapshot
        replicas: 4
        object: snapshot
        requestedCpu: 650m
        requestedMemory: 500Mi

journalClientCassandraChecksConfiguration:
  cls: kafka
  brokersConfigurationRef: internalSecuredKafkaBrokers
  sasl.mechanism: SCRAM-SHA-512
  security.protocol: SASL_SSL
  sasl.username: ${BROKER_USER}
  sasl.password: ${BROKER_USER_PASSWORD}
  message.max.bytes: 524288000
  prefix: swh.journal.objects
  group_id: swh-archive-prod-checks
  # To override per instance
  object_types: []
  secrets:
    BROKER_USER:
      secretKeyRef: swh-archive-broker-secret
      secretKeyName: BROKER_USER
    BROKER_USER_PASSWORD:
      secretKeyRef: swh-archive-broker-secret
      secretKeyName: BROKER_USER_PASSWORD

cassandraChecks:
  enabled: false
  directoryOutput: /volume/cassandra-checks-volume
  volume:
    name: cassandra-checks-volume
    mountPath: /volume
    # readOnly: true
    volumeDefinition:
      hostPath:
        path: /srv/kubernetes/volumes
        type: Directory
  priorityClassName: swh-background-workload
  nodeSelector:
    kubernetes.io/hostname: rancher-node-metal01
  storagePostgresqlConfigurationRef: postgresqlROStorageConfiguration
  storageCassandraConfigurationRef: cassandraChecksROStorage
  journalClientConfigurationRef: journalClientCassandraChecksConfiguration
  deployments:
    origin:
      enabled: false
      replicas: 4
      journalClientOverrides:
        #on_eof: stop
        object_types:
          - origin
        batch_size: 1000
    origin-visit:
      enabled: false
      replicas: 4
      journalClientOverrides:
        #on_eof: stop
        object_types:
          - origin_visit
        batch_size: 1000
    origin-visit-status:
      enabled: false
      replicas: 4
      journalClientOverrides:
        #on_eof: stop
        object_types:
          - origin_visit_status
        batch_size: 1000
    skipped-content:
      enabled: false
      replicas: 1
      journalClientOverrides:
        #on_eof: stop
        object_types:
        - skipped_content
        batch_size: 1000
    content:
      replicas: 64
      journalClientOverrides:
        #on_eof: stop
        object_types:
        - content
        batch_size: 2000
    directory:
      enabled: false
      replicas: 48
      journalClientOverrides:
        #on_eof: stop
        object_types:
          - directory
        batch_size: 400
    revision:
      enabled: false
      replicas: 24
      requestedCpu: 600m
      journalClientOverrides:
        #on_eof: stop
        object_types:
          - revision
        batch_size: 1000
        privileged: true
    release:
      enabled: false
      replicas: 1
      journalClientOverrides:
        on_eof: stop
        object_types:
          - release
        batch_size: 1000
        privileged: true
    snapshot:
      enabled: false
      replicas: 2
      journalClientOverrides:
        #on_eof: stop
        object_types:
          - snapshot
        batch_size: 200
    extid:
      enabled: false
      replicas: 4
      journalClientOverrides:
        #on_eof: stop
        object_types:
        - extid
        batch_size: 200
    metadata:
      enabled: false
      replicas: 6
      journalClientOverrides:
        #on_eof: stop
        object_types:
        - raw_extrinsic_metadata
        batch_size: 1000

objstorage:
  enabled: true
  logLevel: WARN
  priorityClassName: frontend-rpc
  deployments:
    read-only:
      enabled: true
      gunicorn:
        threads: 4
        workers: 4
        timeout: 60
      replicas: 2
      objstorageConfigurationRef: multiplexerForLocalStoragesConfiguration
        # Deploy an ingress to access the objstorage
      hosts:
        - objstorage-read-only-rpc-ingress-swh-cassandra
        - objstorage.internal.softwareheritage.org
      ingress:
        enabled: true
        # mandatory if ingress is enabled
        # the hostname on which the objstorage must be reachable
        # Optional: the ingress classname to use
        className: nginx
        whitelistSourceRangeRef: internalNetworkRanges
        extraAnnotations:
          nginx.ingress.kubernetes.io/proxy-body-size: 4G
          nginx.ingress.kubernetes.io/proxy-buffering: "on"
          nginx.ingress.kubernetes.io/client-body-buffer-size: 128K
        endpoints:
          default:
            paths:
              - path: /
            extraWhitelistSourceRange:
              # vpn network
              - 192.168.101.0/24
      # objstorage read-only
      extraIngresses:
        # Allow access through the public reverse proxy (authenticated) for all IPs
        - hosts:
            - objstorage.softwareheritage.org
          whitelistSourceRangeRef: null
          endpoints:
            default:
              extraWhitelistSourceRange: []
              authentication: swh-cassandra/ingress-objstorage-ro-auth-secrets
    ro-saam-zfs:
      enabled: true
      requestedCpu: 250m
      requestedMemory: 1Gi
      replicas: 2
      gunicorn:
        workers: 4
        threads: 2
        timeout: 3600
      objstorageConfigurationRef: pathslicingSaamZfsObjstorageConfiguration
      extraRpcConfiguration:
        client_max_size: 1073741824
      extraVolumes:
        pathslicing:
          mountPath: /srv/softwareheritage/objects
          volumeDefinition:
            hostPath:
              path: /srv/softwareheritage/objects
              type: Directory
      # Deploy only on saam
      nodeSelector:
        kubernetes.io/hostname: saam
      # And add a specific affinity
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: swh/objstorage-pathslicing
                operator: In
                values:
                - "true"
      # Deploy an ingress to access the objstorage
      hosts:
        - objstorage-ro-saam-zfs-rpc-ingress-swh-cassandra
      ingress:
        enabled: true
        # mandatory if ingress is enabled
        # the hostname on which the objstorage must be reachable
        # Optional: the ingress classname to use
        className: nginx
        whitelistSourceRangeRef: internalNetworkRanges
        extraAnnotations:
          nginx.ingress.kubernetes.io/proxy-body-size: 4G
          nginx.ingress.kubernetes.io/proxy-buffering: "on"
          nginx.ingress.kubernetes.io/client-body-buffer-size: 128K
        endpoints:
          default:
            paths:
              - path: /
          deny-write:
            paths:
              - path: /content/add
                path_type: Prefix
            extraAnnotations:
              nginx.ingress.kubernetes.io/denylist-source-range: 0.0.0.0/0
              nginx.ingress.kubernetes.io/whitelist-source-range: null
          deny-delete:
            paths:
              - path: /content/delete
                path_type: Prefix
            extraAnnotations:
              nginx.ingress.kubernetes.io/denylist-source-range: 0.0.0.0/0
              nginx.ingress.kubernetes.io/whitelist-source-range: null
      extraIngresses:
        - hosts:
            - objstorage-delete-saam-zfs-rpc-ingress-swh-cassandra
          endpoints:
            deny-delete: null
    ro-banco-xfs:
      enabled: true
      requestedCpu: 250m
      requestedMemory: 1Gi
      replicas: 2
      gunicorn:
        workers: 8
        threads: 1
        timeout: 3600
      objstorageConfigurationRef: pathslicingBancoXfsObjstorageConfiguration
      extraRpcConfiguration:
        client_max_size: 1073741824
      extraVolumes:
        pathslicing:
          mountPath: /srv/softwareheritage/objects-xfs
          volumeDefinition:
            hostPath:
              path: /srv/softwareheritage/objects-xfs
              type: Directory
      # Deploy only this specific objstorage instance on banco
      nodeSelector:
        kubernetes.io/hostname: banco
      # And add a specific affinity
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: swh/objstorage-pathslicing
                operator: In
                values:
                - "true"
      # Deploy an ingress to access the objstorage
      hosts:
        - objstorage-ro-banco-xfs-rpc-ingress-swh-cassandra
      ingress:
        enabled: true
        # mandatory if ingress is enabled
        # the hostname on which the objstorage must be reachable
        # Optional: the ingress classname to use
        className: nginx
        whitelistSourceRangeRef: internalNetworkRanges
        extraAnnotations:
          nginx.ingress.kubernetes.io/proxy-body-size: 4G
          nginx.ingress.kubernetes.io/proxy-buffering: "on"
          nginx.ingress.kubernetes.io/client-body-buffer-size: 128K
        endpoints:
          default:
            paths:
              - path: /
          deny-write:
            paths:
              - path: /content/add
                path_type: Prefix
            extraAnnotations:
              nginx.ingress.kubernetes.io/denylist-source-range: 0.0.0.0/0
              nginx.ingress.kubernetes.io/whitelist-source-range: null
          deny-delete:
            paths:
              - path: /content/delete
                path_type: Prefix
            extraAnnotations:
              nginx.ingress.kubernetes.io/denylist-source-range: 0.0.0.0/0
              nginx.ingress.kubernetes.io/whitelist-source-range: null
      extraIngresses:
        - hosts:
            - objstorage-delete-banco-xfs-rpc-ingress-swh-cassandra
          endpoints:
            deny-delete: null

indexerStorage:
  enabled: true
  logLevel: INFO
  deployments:
    read-only:
      checkDbVersion: true
      gunicorn:
        workers: 8
        threads: 1
        timeout: 120
      autoScaling:
        minReplicaCount: 2
        maxReplicaCount: 4
        cpuPercentageUsage: 90
      requestedCpu: 500m
      requestedMemory: 512Mi
      indexerStorageConfigurationRef: postgresqlReadOnlyIndexerStorageConfiguration
      hosts:
        - indexer-storage-read-only-rpc-ingress-swh-cassandra
      ingress:
        enabled: true
        extraAnnotations:
          nginx.ingress.kubernetes.io/proxy-connect-timeout: "90"
          nginx.ingress.kubernetes.io/proxy-send-timeout: "90"
          nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
          nginx.ingress.kubernetes.io/proxy-request-buffering: "on"
          nginx.ingress.kubernetes.io/proxy-body-size: "4G"
        # Default allowed ip ranges that can be extended per ingress definitions paths
        whitelistSourceRangeRef: clusterNetworkRanges
        endpoints:
          default:
            paths:
              - path: /
    read-write:
      checkDbVersion: true
      gunicorn:
        workers: 8
        threads: 1
        timeout: 120
      autoScaling:
        minReplicaCount: 2
        maxReplicaCount: 4
        cpuPercentageUsage: 100
      requestedCpu: 100m
      requestedMemory: 512Mi
      indexerStorageConfigurationRef: postgresqlIndexerStorageConfiguration
      journalWriterConfigurationRef: indexerJournalWriterConfiguration
      hosts:
        - indexer-storage-read-write-rpc-ingress-swh-cassandra
      ingress:
        enabled: true
        extraAnnotations:
          nginx.ingress.kubernetes.io/proxy-connect-timeout: "90"
          nginx.ingress.kubernetes.io/proxy-send-timeout: "90"
          nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
          nginx.ingress.kubernetes.io/proxy-request-buffering: "on"
          nginx.ingress.kubernetes.io/proxy-body-size: "4G"
        # Default allowed ip ranges that can be extended per ingress definitions paths
        whitelistSourceRangeRef: clusterNetworkRanges
        endpoints:
          default:
            paths:
              - path: /

scheduler:
  enabled: true
  sentry:
    enabled: true
  schedulerConfigurationRef: remoteSchedulerConfiguration
  celeryConfigurationRef: producerCeleryConfiguration
  alerts:
    enabled: true
    period: 15m
    severity: warning
    tooManyMessagesInQueue:
      instances:  # We may have more than one rabbitmq per environment
        saatchi:
          threshold: 30000
  recurrent:
    enabled: true
  rpc:
    enabled: true
    # The scheduler instance to use for rpc must be a postgresql instance
    schedulerConfigurationRef: postgresqlSchedulerConfiguration
    replicas: 4
    gunicorn:
      threads: 4
      workers: 8
      timeout: 3600
    hosts:
      # Used by future add-forge-now runner0 vm
      - scheduler.internal.softwareheritage.org
      - scheduler-rpc-ingress-swh-cassandra
    ingress:
      enabled: true
      # TODO: Improve the authorization internal cluster ip range.
      # Current internal range retrieved out of the `kubectl cluster-info dump`
      # Default allowed ip ranges that can be extended per ingress definitions paths
      whitelistSourceRangeRef: internalNetworkRanges
      endpoints:
        default:
          paths:
            - path: /
          extraWhitelistSourceRange:
          # add-forge-now runner0 in staging network
            - 192.168.130.221/32
        read-only:
          paths:
            - path: /scheduler_metrics/get
              pathType: Exact
            - path: /listers/get
              pathType: Exact
            - path: /lister/get
              pathType: Exact
            - path: /task_type/get
              pathType: Exact
            - path: /task_type/get_all
              pathType: Exact
          extraWhitelistSourceRange:
            # vpn network
            - 192.168.101.0/24
            # add-forge-now runner0 in staging network
            - 192.168.130.221/32
  updateMetrics:
    enabled: true
    concurrencyPolicy: Forbid
    # At minute 27 past every 4th hour from 3 through 23
    cron: "27 3-23/4 * * *"
  journalClient:
    enabled: true
    journalConfigurationRef: journalClientConfiguration
  extraServices:
    runner:
      enabled: true
      logLevel: INFO
      period: 10
    runner-priority:
      enabled: true
      logLevel: INFO
      period: 10
      extraConfig:
        - load-bzr
        - load-cvs
        - load-git
        - load-svn
        - load-archive-files
        - load-hg
    listener:
      enabled: true
      replicas: 4
      logLevel: INFO

vault:
  enabled: true
  priorityClassName: frontend-rpc
  logLevel: INFO
  schedulerConfigurationRef: remoteSchedulerConfiguration
  vaultConfigurationRef: postgresqlVaultConfiguration
  storageConfigurationRef: remoteROStorageConfiguration
  objstorageConfigurationRef: roObjstorageBestEffortConfiguration
  cacheConfigurationRef: azureCacheConfiguration
  replicas: 2
  gunicorn:
    threads: 5
    workers: 4
    timeout: 3600
  # RPC services may have different profiles than the rest so they need their specific
  # setup
  requestedMemory: 512Mi
  requestedCpu: 500m
  hosts:
    - vault-rpc-ingress-swh-cassandra
  ingress:
    enabled: true
    # Optional: the ingress classname to use
    # className: nginx
    extraAnnotations:
      kubernetes.io/ingress.class: nginx
      nginx.ingress.kubernetes.io/proxy-connect-timeout: "90"
      nginx.ingress.kubernetes.io/proxy-send-timeout: "90"
      nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
      nginx.ingress.kubernetes.io/proxy-request-buffering: "on"
      nginx.ingress.kubernetes.io/proxy-body-size: "4G"
    # Default allowed ip ranges that can be extended per ingress definitions paths
    whitelistSourceRangeRef: clusterNetworkRanges
    endpoints:
      default:
        paths:
          - path: /

search:
  enabled: true
  priorityClassName: frontend-rpc
  logLevel: INFO
  elasticsearchConfigurationRef: elasticsearchConfiguration
  replicas: 4
  gunicorn:
    workers: 2
    threads: 2
    timeout: 3600
  requestedCpu: 250m
  requestedMemory: 512Mi
  # autoScaling:
  #   minReplicaCount: 2
  #   maxReplicaCount: 4
  #   cpuPercentageUsage: 100
  hosts:
    - search-rpc-ingress-swh-cassandra
    - search.internal.softwareheritage.org
  ingress:
    enabled: true
    # Optional: the ingress classname to use
    # className: nginx
    extraAnnotations:
      nginx.ingress.kubernetes.io/proxy-connect-timeout: "90"
      nginx.ingress.kubernetes.io/proxy-send-timeout: "90"
      nginx.ingress.kubernetes.io/proxy-read-timeout: "3600"
      nginx.ingress.kubernetes.io/proxy-request-buffering: "on"
      nginx.ingress.kubernetes.io/proxy-body-size: "4G"
    # Default allowed ip ranges that can be extended per ingress definitions paths
    whitelistSourceRangeRef: internalNetworkRanges
    endpoints:
      default:
        paths:
          - path: /
      read-only:
        paths:
          - path: /
            pathType: Exact
          - path: /origin/search
            pathType: Exact
          - path: /origin/get
            pathType: Exact
          - path: /visit_types_count
            pathType: Exact
          - path: /origin-read/
        extraWhitelistSourceRange:
          # vpn access
          - 192.168.101.0/24

  journalClients:
    enabled: true
    priorityClassName: normal-workload
    searchConfigurationRef: remoteSearchConfiguration
    storageConfigurationRef: remoteStorageConfiguration
    journalConfigurationRef: searchJournalClientConfiguration
    deployments:
      objects:
        replicas: 1
        # requestedCpu: 10m
        # requestedMemory: 50Mi
        journalClientOverrides:
          group_id: swh.search.journal_client-v0.11
          prefix: swh.journal.objects
          object_types:
          - origin
          - origin_visit_status
      indexed:
        replicas: 1
        # requestedCpu: 10m
        # requestedMemory: 50Mi
        journalClientOverrides:
          group_id: swh.search.journal_client.indexed-v0.11
          prefix: swh.journal.indexed
          object_types:
          - origin_intrinsic_metadata
          - origin_extrinsic_metadata

counters:
  enabled: true
  journalClient:
    # TODO: enable when decommissioning the swh namespace
    enabled: true
    countersConfigurationRef: remoteCountersConfiguration
    journalConfigurationRef: journalClientCountersConfiguration
  refreshCountersCache:
    enabled: true
    cron: "0 */1 * * *"
    concurrencyPolicy: Forbid
    countersConfigurationRef: remoteCountersConfiguration
    historyFiles:
      # cache file
      - history.json
      # static counter history (from swh's inception)
      - static_history.json
  rpc:
    enabled: true
    fetchStaticHistory: true
    scrapeMetrics: true
    cacheBaseDirectory: /srv/softwareheritage/counters
    countersConfigurationRef: countersRedis
    historyConfigurationRef: countersHistoryConfiguration
    replicas: 2
    gunicorn:
      workers: 2
      threads: 1
      timeout: 30
    # autoScaling:
    #   minReplicaCount: 2
    #   maxReplicaCount: 4
    #   cpuPercentageUsage: 100
    hosts:
      - counters-rpc-ingress-swh-cassandra
      - counters.internal.softwareheritage.org
    ingress:
      enabled: true
      # Default allowed ip ranges that can be extended per ingress definitions paths
      whitelistSourceRangeRef: internalNetworkRanges
      endpoints:
        default:
          paths:
            - path: /
          extraWhitelistSourceRange:
            # vpn network
            - 192.168.101.0/24

rpcRWStorageCassandraConfiguration:
  cls: remote
  url: http://storage-rw-cassandra-ingress-swh-cassandra

rpcWriterWorkloadStorageCassandraConfiguration:
  pipelineStepsRef: storagePipelineSteps
  storageConfigurationRef: rpcRWStorageCassandraConfiguration

deposit:
  enabled: true
  logLevel: INFO
  requestedCpu: 500m
  requestedMemory: 500Mi
  migrationsEnabled: false
  replicas: 2
  hosts:
    - deposit.softwareheritage.org
    - deposit-dynamic.internal.softwareheritage.org
    - deposit-rpc-ingress-swh-cassandra
  ingress:
    enabled: true
    extraAnnotations:
      kubernetes.io/ingress.class: nginx
    endpoints:
      default:
        paths:
          - path: /
          - path: /static
            port: 80
      authenticated:
        paths:
          - path: /1/private/
        # auth-file with authentication
        authentication: swh-cassandra/deposit-auth-secrets
  databaseConfigurationRef: postgresqlDepositConfiguration
  schedulerConfigurationRef: remoteSchedulerConfiguration
  storageConfigurationRef: remoteStorageConfiguration
  storageMetadataConfigurationRef: rpcRWStorageCassandraConfiguration
  djangoConfigurationRef: djangoDepositConfiguration
  blobstorageConfigurationRef: azureDepositConfiguration
  keycloakConfigurationRef: keycloakConfiguration
  extraConfig:
    max_upload_size: 209715200
    extraction_dir: "/tmp/swh-deposit/archive/"
    cache_uri: memcached:11211

provenance:
  enabled: true
  deployments:
    graph-granet:
      graphConfigurationRef: provenanceGraphGrpcConfiguration
      replicas: 2
      gunicorn:
        workers: 4
        threads: 1
      hosts:
        - webapp-provenance-ingress-swh-cassandra
      ingress:
        enabled: true
        whitelistSourceRangeRef: clusterNetworkRanges
        extraAnnotations:
          nginx.ingress.kubernetes.io/proxy-body-size: 4G
          nginx.ingress.kubernetes.io/proxy-buffering: "on"
          nginx.ingress.kubernetes.io/client-body-buffer-size: 128K
        endpoints:
          default:
            paths:
              - path: /
      extraIngresses:
       - hosts:
         - provenance.internal.softwareheritage.org
         whitelistSourceRangeRef: internalNetworkRanges
         endpoints:
           default:
             paths:
               - path: /
             extraWhitelistSourceRange:
               - 192.168.50.0/24 # for blackbox monitoring
               - 192.168.101.0/24 # vpn network

indexers:
  enabled: true
  priorityClassName: low-workload
  storageConfigurationRef: remoteROStorageConfiguration
  schedulerConfigurationRef: remoteSchedulerConfiguration
  indexerStorageConfigurationRef: remoteReadWriteIndexerStorageConfiguration
  objstorageConfigurationRef: roObjstorageHighParallelismConfiguration
  journalClientConfigurationRef: authenticatedJournalClientConfiguration
  deployments:
    extrinsic:
      indexer_type: extrinsic_metadata
      journalClientOverrides:
        group_id: swh-archive-prod-swh.indexer.journal_client.extrinsic_metadata
        prefix: swh.journal.objects
        batch_size: 200
      requestedCpu: 50m
      requestedMemory: 200Mi
      extraConfig:
        tools:
          name: swh-metadata-detector
          version: 0.0.2
          configuration: {}
      autoScaling:
        maxReplicaCount: 12
    content-mimetype:
      autoScaling:
        maxReplicaCount: 1
      journalClientConfigurationRef: authenticatedIndexerProd01JournalClientConfiguration
      indexer_type: content_mimetype
      journalClientOverrides:
        group_id: swh-indexer-prod-01-swh.indexer.journal_client.content_mimetype
        batch_size: 200
      extraConfig:
        tools:
          name: file
          version: 2:0.4.15-2
          configuration:
            type: library
            debian-package: python3-magic
        write_batch_size: 1000
    origin-intrinsic:
      enabled: false
      autoScaling:
        maxReplicaCount: 1
      storageConfigurationRef: remoteROCassandraIngressStorageConfiguration
      journalClientConfigurationRef: authenticatedIndexerProd01JournalClientConfiguration
      indexer_type: origin_intrinsic_metadata
      journalClientOverrides:
        group_id: swh-indexer-prod-01-swh.indexer.journal_client.origin_intrinsic_metadata
        batch_size: 200
      extraConfig:
        tools:
          name: swh-metadata-detector
          version: 0.0.2
          configuration: {}

cookers:
  enabled: true
  storageConfigurationRef: remoteROStorageConfiguration
  celeryConfigurationRef: consumerCeleryConfiguration
  vaultConfigurationRef: remoteVaultConfiguration
  graphConfigurationRef: vaultGraphConfiguration
  objstorageConfigurationRef: roObjstorageHighParallelismConfiguration
  deployments:
    simple:
      ackLate: true
      queues:
        - swh.vault.cooking_tasks.SWHCookingTask
      autoScaling:
        minReplicaCount: 1
        maxReplicaCount: 8
    # According to current data, only the previous cooking task are running, hence the
    # lower number of pods
    batch:
      queues:
        - swh.vault.cooking_tasks.SWHBatchCookingTask
      autoScaling:
        minReplicaCount: 1
        maxReplicaCount: 2

listers:
  enabled: true
  storageConfigurationRef: remoteROStorageConfiguration
  schedulerConfigurationRef: remoteSchedulerConfiguration
  celeryConfigurationRef: consumerCeleryConfiguration
  deployments:
    bower:
      queues:
      - swh.lister.bower.tasks.BowerListerTask
      autoScaling:
        maxReplicaCount: 1
    bitbucket:
      queues:
      - swh.lister.bitbucket.tasks.IncrementalBitBucketLister
      - swh.lister.bitbucket.tasks.FullBitBucketRelister
      autoScaling:
        maxReplicaCount: 1
      requestedMemory: 600Mi
      requestedCpu: 200m
    cgit:
      queues:
        - swh.lister.cgit.tasks.CGitListerTask
      autoScaling:
        maxReplicaCount: 2
    cran:
      queues:
      - swh.lister.cran.tasks.CRANListerTask
      autoScaling:
        maxReplicaCount: 1
    debian:
      queues:
        - swh.lister.debian.tasks.DebianListerTask
      autoScaling:
        maxReplicaCount: 1
    gitea:
      queues:
      - swh.lister.gitea.tasks.IncrementalGiteaLister
      - swh.lister.gitea.tasks.RangeGiteaLister
      - swh.lister.gitea.tasks.FullGiteaRelister
      autoScaling:
        maxReplicaCount: 2
    github-full:
      queues:
      - swh.lister.github.tasks.FullGitHubRelister
      - swh.lister.github.tasks.RangeGitHubLister
      autoScaling:
        maxReplicaCount: 24
    github-incremental:
      queues:
      - swh.lister.github.tasks.IncrementalGitHubLister
      autoScaling:
        maxReplicaCount: 1
    gitiles:
      queues:
      - swh.lister.gitiles.tasks.GitilesListerTask
      autoScaling:
        maxReplicaCount: 2
    gitlab:
      queues:
      - swh.lister.gitlab.tasks.IncrementalGitLabLister
      - swh.lister.gitlab.tasks.FullGitLabRelister
      autoScaling:
        maxReplicaCount: 4
    gitweb:
      queues:
      - swh.lister.gitweb.tasks.GitwebListerTask
      autoScaling:
        maxReplicaCount: 2
    gnu-full:
      queues:
        - swh.lister.gnu.tasks.GNUListerTask
      autoScaling:
        maxReplicaCount: 1
    gogs-full:
      queues:
        - swh.lister.gogs.tasks.FullGogsRelister
      autoScaling:
        maxReplicaCount: 1
    golang:
      queues:
      - swh.lister.golang.tasks.FullGolangLister
      - swh.lister.golang.tasks.IncrementalGolangLister
      autoScaling:
        maxReplicaCount: 1
    launchpad:
      queues:
      - swh.lister.launchpad.tasks.FullLaunchpadLister
      - swh.lister.launchpad.tasks.IncrementalLaunchpadLister
      autoScaling:
        maxReplicaCount: 1
    maven:
      queues:
      - swh.lister.maven.tasks.FullMavenLister
      - swh.lister.maven.tasks.IncrementalMavenLister
      autoScaling:
        maxReplicaCount: 1
      requestedCpu: 1000m
      requestedMemory: 6Gi
    npm:
      queues:
      - swh.lister.npm.tasks.NpmListerTask
      autoScaling:
        maxReplicaCount: 1
    nixguix:
      queues:
      - swh.lister.nixguix.tasks.NixGuixListerTask
      autoScaling:
        maxReplicaCount: 2
      extraConfig:
        # extra extensions to ignore
        extensions_to_ignore:
          - rock
    opam:
      queues:
      - swh.lister.opam.tasks.OpamListerTask
      autoScaling:
        maxReplicaCount: 1
    packagist:
      queues:
        - swh.lister.packagist.tasks.PackagistListerTask
      autoScaling:
        maxReplicaCount: 1
    pagure:
      queues:
        - swh.lister.pagure.tasks.PagureListerTask
      autoScaling:
        maxReplicaCount: 2
    phabricator:
      queues:
      - swh.lister.phabricator.tasks.FullPhabricatorLister
      autoScaling:
        maxReplicaCount: 1
    pubdev:
      queues:
        - swh.lister.pubdev.tasks.PubDevListerTask
      autoScaling:
        maxReplicaCount: 1
    pypi:
      queues:
      - swh.lister.pypi.tasks.PyPIListerTask
      autoScaling:
        maxReplicaCount: 1
    rpm:
      queues:
        - swh.lister.rpm.tasks.FullRPMLister
        - swh.lister.rpm.tasks.IncrementalRPMLister
      autoScaling:
        maxReplicaCount: 1
    sourceforge:
      queues:
      - swh.lister.sourceforge.tasks.FullSourceForgeLister
      - swh.lister.sourceforge.tasks.IncrementalSourceForgeLister
      autoScaling:
        maxReplicaCount: 1
    stagit:
      queues:
      - swh.lister.stagit.tasks.StagitListerTask
      autoScaling:
        maxReplicaCount: 2

checkerDeposit:
  enabled: true
  storageConfigurationRef: remoteROStorageConfiguration
  celeryConfigurationRef: consumerCeleryConfiguration
  depositConfigurationRef: depositDynamicConfiguration
  autoScaling:
    queueThreshold: 1
    stopWhenNoActivity: false
    minReplicaCount: 1
    maxReplicaCount: 2
  requestedMemory: 100Mi
  requestedCpu: 100m
  limitedMemory: 1Gi
  limitedCpu: 1000m

webhooks:
  enabled: true
  svixConfigurationRef: svixConfiguration
  journalClientConfigurationRef: journalClientConfiguration
  priorityClassName: frontend-rpc-workload
  autoScaling:
    minReplicaCount: 2
    maxReplicaCount: 5
    lagThreshold: 2000
  deployments:
    origin-visit-status:
      replicas: 0
      dnsConfigurationRef: dnsConfiguration
      requestedCpu: 100m
      requestedMemory: 100Mi
      logLevel: INFO httpx:WARNING
      journalClientOverrides:
        auto_offset_reset: latest
        group_id: swh-archive-prod-webhooks
        object_types:
          - origin_visit_status

loaders:
  enabled: true
  storageConfigurationRef: rpcWriterWorkloadStorageCassandraConfiguration
  celeryConfigurationRef: consumerCeleryConfiguration
  deployments:
    add-forge-now:
      enabled: true
      image: swh_loader_git_image
      requestedMemory: 1Gi
      requestedCpu: 500m
      limitedMemory: 25Gi
      queues:
        - add_forge_now:swh.loader.git.tasks.UpdateGitRepository
      ackLate: true
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 8
      extraConfig:
        overrides:
          swh.loader.git.loader.GitLoader:
            # 10Gib
            temp_file_cutoff: 10737418240
            # 32Gib
            pack_size_bytes: 34359738368
    add-forge-now-slow:
      enabled: true
      image: swh_loader_git_image
      requestedMemory: 1Gi
      requestedCpu: 500m
      limitedMemory: 25Gi
      queues:
        - add_forge_now_slow:swh.loader.git.tasks.UpdateGitRepository
      ackLate: true
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 4
      extraConfig:
        overrides:
          swh.loader.git.loader.GitLoader:
            # 10Gib
            temp_file_cutoff: 10737418240
            # 32Gib
            pack_size_bytes: 34359738368
    archive:
      enabled: true
      requestedMemory: 256Mi
      requestedCpu: 200m
      image: swh_loader_package_image
      queues:
        - swh.loader.package.archive.tasks.LoadTarball
      autoScaling:
        maxReplicaCount: 4
    bzr:
      enabled: true
      requestedMemory: 1Gi
      requestedCpu: 1000m
      queues:
        - swh.loader.bzr.tasks.LoadBazaar
      autoScaling:
        maxReplicaCount: 4
    content:
      enabled: true
      requestedCpu: 350m
      requestedMemory: 150Mi
      queues:
        - swh.loader.core.tasks.LoadContent
      autoScaling:
        maxReplicaCount: 1
      image: swh_loader_package_image
    cran:
      enabled: true
      requestedMemory: 256Mi
      requestedCpu: 200m
      image: swh_loader_package_image
      queues:
        - swh.loader.package.cran.tasks.LoadCRAN
      autoScaling:
        maxReplicaCount: 1
    cvs:
      enabled: true
      requestedCpu: 1000m
      requestedMemory: 2Gi
      queues:
        - swh.loader.cvs.tasks.LoadCvsRepository
      autoScaling:
        maxReplicaCount: 2
    debian:
      enabled: true
      requestedMemory: 256Mi
      requestedCpu: 200m
      image: swh_loader_package_image
      queues:
        - swh.loader.package.debian.tasks.LoadDebian
      autoScaling:
        maxReplicaCount: 1
    deposit:
      enabled: true
      priorityClassName: frontend-rpc-workload
      requestedMemory: 256Mi
      requestedCpu: 200m
      image: swh_loader_package_image
      queues:
        - swh.loader.package.deposit.tasks.LoadDeposit
      autoScaling:
        queueThreshold: 1
        stopWhenNoActivity: false
        minReplicaCount: 1
        maxReplicaCount: 2
      # only used for secrets
      depositConfigurationRef: depositDynamicConfiguration
      extraConfig:
        deposit:
          url: "http://deposit-dynamic.internal.softwareheritage.org/1/private"
          auth:
            username: "${DEPOSIT_USERNAME}"
            password: "${DEPOSIT_PASSWORD}"
        default_filename: archive.tar
    directory:
      enabled: true
      requestedMemory: 768Mi
      requestedCpu: 1000m
      queues:
        - swh.loader.core.tasks.LoadTarballDirectory
      autoScaling:
        maxReplicaCount: 6
      image: swh_loader_package_image
    git:
      enabled: true
      priorityClassName: low-workload
      queues:
        - swh.loader.git.tasks.UpdateGitRepository
        - swh.loader.git.tasks.LoadDiskGitRepository
        - swh.loader.git.tasks.UncompressAndLoadDiskGitRepository
      autoScaling:
        maxReplicaCount: 64
        minReplicaCount: 1
        stopWhenNoActivity: false
        queueThreshold: 200
      requestedMemory: 768Mi
      requestedCpu: 100m
      sysctls:
        net.ipv4.tcp_dsack: 0
    git-checkout:
      enabled: true
      image: swh_loader_git_image
      queues:
        - swh.loader.git.tasks.LoadGitCheckout
      autoScaling:
        maxReplicaCount: 6
      requestedMemory: 256Mi
      requestedCpu: 500m
    git-large-repository:
      enabled: true
      image: swh_loader_git_image
      requestedMemory: 1Gi
      requestedCpu: 800m
      queues:
        - large_repository:swh.loader.git.tasks.UpdateGitRepository
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 12
      extraConfig:
        overrides:
          swh.loader.git.loader.GitLoader:
            # 10Gib
            temp_file_cutoff: 10737418240
            # 32Gib
            pack_size_bytes: 34359738368
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: "swh/loader"
                operator: In
                values:
                - "true"
              - key: "swh/large-scratch-fs"
                operator: In
                values:
                - "true"
    golang:
      enabled: true
      image: swh_loader_package_image
      requestedMemory: 256Mi
      requestedCpu: 200m
      queues:
        - swh.loader.package.golang.tasks.LoadGolang
      autoScaling:
        maxReplicaCount: 4
    hg-checkout:
      enabled: true
      image: swh_loader_mercurial_image
      queues:
        - swh.loader.mercurial.tasks.LoadMercurialCheckout
      autoScaling:
        maxReplicaCount: 1
      requestedMemory: 768Mi
      requestedCpu: 500m
    maven:
      enabled: true
      image: swh_loader_package_image
      queues:
        - swh.loader.package.maven.tasks.LoadMaven
      autoScaling:
        maxReplicaCount: 4
      requestedMemory: 600Mi
      requestedCpu: 500m
    mercurial:
      enabled: true
      queues:
        - swh.loader.mercurial.tasks.LoadArchiveMercurial
        - swh.loader.mercurial.tasks.LoadMercurial
      autoScaling:
        maxReplicaCount: 4
      requestedMemory: 128Mi
      requestedCpu: 500m
    npm:
      enabled: true
      requestedMemory: 256Mi
      requestedCpu: 200m
      image: swh_loader_package_image
      queues:
        - swh.loader.package.npm.tasks.LoadNpm
      autoScaling:
        maxReplicaCount: 4
    oneshot:
      enabled: true
      image: swh_loader_savecodenow_image
      requestedMemory: 768Mi
      requestedCpu: 200m
      limitedMemory: 25Gi
      queues:
        - oneshot:swh.loader.cvs.tasks.LoadCvsRepository
        - oneshot:swh.loader.git.tasks.UpdateGitRepository
        - oneshot:swh.loader.mercurial.tasks.LoadMercurial
        - oneshot:swh.loader.svn.tasks.LoadSvnRepository
        - oneshot:swh.loader.svn.tasks.DumpMountAndLoadSvnRepository
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 32
    opam:
      enabled: true
      image: swh_loader_package_image
      queues:
        - swh.loader.package.opam.tasks.LoadOpam
      autoScaling:
        maxReplicaCount: 4
      requestedMemory: 1Gi
      requestedCpu: 1000m
    pypi:
      enabled: true
      requestedMemory: 256Mi
      requestedCpu: 200m
      image: swh_loader_package_image
      queues:
        - swh.loader.package.pypi.tasks.LoadPyPI
      autoScaling:
        maxReplicaCount: 1
    pubdev:
      enabled: true
      requestedMemory: 256Mi
      requestedCpu: 200m
      image: swh_loader_package_image
      queues:
        - swh.loader.package.pubdev.tasks.LoadPubDev
      autoScaling:
        maxReplicaCount: 1
    save-code-now:
      enabled: true
      requestedMemory: 2Gi
      requestedCpu: 200m
      limitedMemory: 25Gi
      queues:
        - save_code_now:swh.loader.bzr.tasks.LoadBazaar
        - save_code_now:swh.loader.cvs.tasks.LoadCvsRepository
        - save_code_now:swh.loader.git.tasks.UpdateGitRepository
        - save_code_now:swh.loader.git.tasks.LoadDiskGitRepository
        - save_code_now:swh.loader.git.tasks.UncompressAndLoadDiskGitRepository
        - save_code_now:swh.loader.mercurial.tasks.LoadArchiveMercurial
        - save_code_now:swh.loader.mercurial.tasks.LoadMercurial
        - save_code_now:swh.loader.svn.tasks.LoadSvnRepository
        - save_code_now:swh.loader.svn.tasks.MountAndLoadSvnRepository
        - save_code_now:swh.loader.svn.tasks.DumpMountAndLoadSvnRepository
        - save_code_now:swh.loader.package.archive.tasks.LoadTarball
      ackLate: true
      autoScaling:
        stopWhenNoActivity: false
        queueThreshold: 1
        minReplicaCount: 16
        maxReplicaCount: 16
    svn:
      enabled: true
      queues:
        - swh.loader.svn.tasks.LoadSvnRepository
        - swh.loader.svn.tasks.MountAndLoadSvnRepository
        - swh.loader.svn.tasks.DumpMountAndLoadSvnRepository
      autoScaling:
        maxReplicaCount: 4
      requestedMemory: 6Gi
      requestedCpu: 100m
      limitedMemory: 25Gi
    svn-export:
      enabled: true
      requestedMemory: 768Mi
      requestedCpu: 1000m
      limitedMemory: 1Gi
      limitedCpu: 1500m
      queues:
        - swh.loader.svn.tasks.LoadSvnExport
      autoScaling:
        maxReplicaCount: 1
      image: swh_loader_svn_image

loaderMetadata:
  enabled: true
  storageConfigurationRef: rpcWriterWorkloadStorageCassandraConfiguration
  schedulerConfigurationRef: remoteSchedulerConfiguration
  consumerGroup: loader_metadata.journal_client
  prefix: swh.journal.objects
  journalBrokers:
    secretName: swh-archive-broker-secret
    hosts:
      - kafka1.internal.softwareheritage.org:9094
      - kafka2.internal.softwareheritage.org:9094
      - kafka3.internal.softwareheritage.org:9094
      - kafka4.internal.softwareheritage.org:9094
    user: swh-archive-prod
  autoScaling:
    maxReplicaCount: 6

objstorageReplayer:
  enabled: true
  journalClientConfigurationRef: authenticatedJournalClientConfiguration
  extraCliLogLevel: "--log-level azure.core.pipeline.policies.http_logging_policy:WARNING"
  deployments:
    winery:
      enabled: true
      destinationObjstorageConfigurationRef: wineryObjstorageRWConfiguration
      sourceObjstorageConfigurationRef: roObjstorageForWineryReplayerConfiguration
      replicas: 16
      fetchConcurrency: 20
      checkDestination: "true"
      journalClientOverrides:
        group_id: swh-archive-prod-winery-content-replayer-check
        auto_offset_reset: earliest
        batch_size: 1000
      error_reporter:
        host: redis-winery-replay.redis
        port: 6379
        db: 1
    s3:
      enabled: true
      destinationObjstorageConfigurationRef: s3RWObjectstorageConfiguration
      sourceObjstorageConfigurationRef: roObjstorageForS3ReplayerConfiguration
      replicas: null  # handled by keda autoscaling
      fetchConcurrency: 20
      journalClientOverrides:
        group_id: swh-archive-prod-s3-content-replayer
        auto_offset_reset: earliest
        batch_size: 1000
      autoScaling:
        minReplicaCount: 4
        stopWhenNoActivity: false
        maxReplicaCount: 32
        advancedKedaConfig:
          horizontalPodAutoscalerConfig:
            behavior:
              scaleDown:
                # Only scale down every 300 seconds
                stabilizationWindowSeconds: 300
                # Remove at most 25% or 4 pods over a 300 second period
                selectPolicy: Min
                policies:
                - periodSeconds: 300
                  type: Percent
                  value: 25
                - periodSeconds: 300
                  type: Pods
                  value: 4
              scaleUp:
                # Only scale up every 300 seconds
                stabilizationWindowSeconds: 300
                # Add at most 25% of total, or 4 pods, over a 300 second period
                policies:
                - periodSeconds: 300
                  type: Percent
                  value: 25
                - periodSeconds: 300
                  type: Pods
                  value: 4
                selectPolicy: Min

# Rpc Rust graph configuration (the rpc instance spawns a grpc instance too)
rpcLocalRustWithGrpcGraphConfiguration:
  cls: local_rust
  grpc_server:
    port: 50091

# The rpc graph instance will communicate with another grpc instance
rpcWithRemoteGrpcGraphConfiguration:
  cls: remote
  url: graph-grpc-20240331-ingress:80
  grpc_server:
    port: 80

plainGrpcGraphConfiguration:
  max_ram: 500g

graph:
  enabled: true
  deployments:
    # grpc graph with test dataset
    grpc-20240331:
      enabled: true
      type: grpc
      port: 50091
      nodeSelector:
        kubernetes.io/hostname: rancher-node-metal05
      requestedMemory: 500Gi
      graphConfigurationRef: plainGrpcGraphConfiguration
      dataset:
        name: 2024-03-31
        reindex: true
      startService: true
      prepareMemoryVolume: true
      extraVolumes:
        graph-20240331-persistent:
          mountPath: /srv/dataset
          persistentVolumeClaimDefinition:
            storageClassName: local-persistent
            volumeMode: Filesystem
            accessModes:
            - ReadWriteOnce
            resources:
              requests:
                storage: 1Gi
        # in-memory volumes
        graph-20240331-inmemory:
          mountPath: /srv/graph
          persistentVolumeClaimDefinition:
            storageClassName: local-path
            volumeMode: Filesystem
            accessModes:
            - ReadWriteOnce
            resources:
              requests:
                storage: 1Gi
      hosts:
        - graph-grpc.internal.softwareheritage.org
        - graph-grpc-20240331-ingress
      ingress:
        enabled: true
        whitelistSourceRangeRef: internalNetworkRanges
        extraAnnotations:
          nginx.ingress.kubernetes.io/proxy-body-size: 4G
          nginx.ingress.kubernetes.io/proxy-buffering: "on"
          nginx.ingress.kubernetes.io/client-body-buffer-size: 128K
        endpoints:
          default:
            paths:
              - path: /
            extraWhitelistSourceRange:
              # vpn network
              - 192.168.101.0/24
    # rpc graph which hit the grpc graph instance declared above ^
    rpc-20240331:
      enabled: false
      type: rpc
      port: 5009
      graphConfigurationRef: rpcWithRemoteGrpcGraphConfiguration
      startService: false
      hosts:
        - graph-rpc.internal.softwareheritage.org
        - graph-rpc-20240331-ingress
      ingress:
        enabled: true
        whitelistSourceRangeRef: internalNetworkRanges
        extraAnnotations:
          nginx.ingress.kubernetes.io/proxy-body-size: 4G
          nginx.ingress.kubernetes.io/proxy-buffering: "on"
          nginx.ingress.kubernetes.io/client-body-buffer-size: 128K
        endpoints:
          default:
            paths:
              - path: /
            extraWhitelistSourceRange:
              # vpn network
              - 192.168.101.0/24
