namespace: swh-cassandra
sentry:
  environment: staging

noopObjectStorage:
  cls: noop

cassandraSeeds:
  - cassandra1.internal.staging.swh.network
  - cassandra2.internal.staging.swh.network
  - cassandra3.internal.staging.swh.network

cassandraStorage:
  cls: cassandra
  cassandraSeedsRef: cassandraSeeds
  keyspace: swh
  initKeyspace: true
  consistencyLevel: LOCAL_QUORUM
  specificOptions:
    directory_entries_insert_algo: batch
  authProvider:
    cls: cassandra.auth.PlainTextAuthProvider
    username: swh-rw
    password: ${CASSANDRA_PASSWORD}
  secrets:
    CASSANDRA_PASSWORD:
      secretKeyRef: common-secrets
      secretKeyName: cassandra-swh-rw-password

cassandraReplayerStorageConfiguration:
  storageConfigurationRef: cassandraStorage
  objectStorageConfigurationRef: noopObjectStorage

cassandraStorageConfiguration:
  storageConfigurationRef: cassandraStorage
  # TODO: add journal_writer
  # TODO: add objstorage configuration

storagePipelineSteps:
  - cls: buffer
    min_batch_size:
      content: 100
      content_bytes: 52428800
      directory: 100
      directory_entries: 500
      revision: 100
      revision_parents: 200
      revision_bytes: 52428800
      release: 100
      release_bytes: 52428800
      extid: 100
  - cls: filter
  - cls: retry

localRpcRWStorageConfiguration:
  cls: remote
  host: http://storage:5002

rpcRWStorageConfiguration:
  pipelineStepsRef: storagePipelineSteps
  storageConfigurationRef: localRpcRWStorageConfiguration

# (Not so) readonly (namespace local) storage
localRpcROStorageConfiguration:
  storageConfigurationRef: localRpcRWStorageConfiguration

remoteSchedulerConfiguration:
  cls: remote
  host: scheduler.internal.staging.swh.network
  port: 80

readWriteCeleryConfiguration:
  host: scheduler0.internal.staging.swh.network
  port: 5672
  user: swhconsumer
  pass: ${AMQP_PASSWORD}
  secrets:
    AMQP_PASSWORD:
      secretKeyRef: amqp-secrets
      secretKeyName: read-write

depositConfiguration:
  host: deposit-rp.internal.staging.swh.network
  user: ${DEPOSIT_USERNAME}
  pass: ${DEPOSIT_PASSWORD}
  secrets:
    DEPOSIT_USER:
      secretKeyRef: deposit-secrets
      secretKeyName: username
    DEPOSIT_PASSWORD:
      secretKeyRef: deposit-secrets
      secretKeyName: password

loaders:
  enabled: true
  storageConfigurationRef: rpcRWStorageConfiguration
  celeryConfigurationRef: readWriteCeleryConfiguration
  depositConfigurationRef: depositConfiguration
  deployments:
    add-forge-now:
      image: swh_loader_git_image
      queues:
        - add_forge_now:swh.loader.git.tasks.UpdateGitRepository
      ackLate: true
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 3
      requestedMemory: 1024Mi
      requestedCpu: 200m
    add-forge-now-slow:
      image: swh_loader_git_image
      queues:
        - add_forge_now_slow:swh.loader.git.tasks.UpdateGitRepository
      ackLate: true
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 1
      requestedMemory: 1024Mi
      requestedCpu: 200m
    archive:
      requestedMemory: 256Mi
      requestedCpu: 200m
      image: swh_loader_package_image
      queues:
        - swh.loader.package.archive.tasks.LoadTarball
      autoScaling:
        maxReplicaCount: 1
    bzr:
      requestedMemory: 256Mi
      requestedCpu: 200m
      queues:
        - swh.loader.bzr.tasks.LoadBazaar
      autoScaling:
        maxReplicaCount: 1
    cran:
      requestedMemory: 256Mi
      requestedCpu: 200m
      image: swh_loader_package_image
      queues:
        - swh.loader.package.cran.tasks.LoadCRAN
      autoScaling:
        maxReplicaCount: 1
    cvs:
      requestedMemory: 256Mi
      requestedCpu: 200m
      queues:
        - swh.loader.cvs.tasks.LoadCvsRepository
      autoScaling:
        maxReplicaCount: 1
    content:
      requestedCpu: 350m
      requestedMemory: 150Mi
      queues:
        - swh.loader.core.tasks.LoadContent
      autoScaling:
        maxReplicaCount: 1
      image: swh_loader_package_image
    directory:
      requestedMemory: 768Mi
      requestedCpu: 1000m
      limitedMemory: 1024Mi
      limitedCpu: 1500m
      queues:
        - swh.loader.core.tasks.LoadTarballDirectory
      autoScaling:
        maxReplicaCount: 1
      image: swh_loader_package_image
    git:
      priorityClassName: low-workload
      queues:
        - swh.loader.git.tasks.UpdateGitRepository
        - swh.loader.git.tasks.LoadDiskGitRepository
        - swh.loader.git.tasks.UncompressAndLoadDiskGitRepository
      autoScaling:
        maxReplicaCount: 1
        minReplicaCount: 1
        stopWhenNoActivity: false
      requestedMemory: 768Mi
      requestedCpu: 100m
    git-checkout:
      image: swh_loader_git_image
      queues:
        - swh.loader.git.tasks.LoadGitCheckout
      autoScaling:
        maxReplicaCount: 1
      requestedMemory: 256Mi
      requestedCpu: 500m
    hg-checkout:
      image: swh_loader_mercurial_image
      queues:
        - swh.loader.mercurial.tasks.LoadMercurialCheckout
      autoScaling:
        maxReplicaCount: 1
      requestedMemory: 768Mi
      requestedCpu: 500m
    svn-export:
      requestedMemory: 768Mi
      requestedCpu: 1000m
      limitedMemory: 1024Mi
      limitedCpu: 1500m
      queues:
        - swh.loader.svn.tasks.LoadSvnExport
      autoScaling:
        maxReplicaCount: 1
      image: swh_loader_svn_image
    debian:
      requestedMemory: 256Mi
      requestedCpu: 200m
      image: swh_loader_package_image
      queues:
        - swh.loader.package.debian.tasks.LoadDebian
      autoScaling:
        maxReplicaCount: 1
    deposit:
      requestedMemory: 256Mi
      requestedCpu: 200m
      image: swh_loader_package_image
      queues:
        - swh.loader.package.deposit.tasks.LoadDeposit
      autoScaling:
        queueThreshold: 1
        maxReplicaCount: 2
      extraConfig:
        deposit:
          url: "https://deposit-rp.internal.staging.swh.network/1/private"
          auth:
            username: "${DEPOSIT_USERNAME}"
            password: "${DEPOSIT_PASSWORD}"
        default_filename: archive.tar
    golang:
      image: swh_loader_package_image
      requestedMemory: 256Mi
      requestedCpu: 200m
      queues:
        - swh.loader.package.golang.tasks.LoadGolang
      autoScaling:
        maxReplicaCount: 1
    save-code-now:
      queues:
        - save_code_now:swh.loader.bzr.tasks.LoadBazaar
        - save_code_now:swh.loader.cvs.tasks.LoadCvsRepository
        - save_code_now:swh.loader.git.tasks.UpdateGitRepository
        - save_code_now:swh.loader.git.tasks.LoadDiskGitRepository
        - save_code_now:swh.loader.git.tasks.UncompressAndLoadDiskGitRepository
        - save_code_now:swh.loader.mercurial.tasks.LoadArchiveMercurial
        - save_code_now:swh.loader.mercurial.tasks.LoadMercurial
        - save_code_now:swh.loader.svn.tasks.LoadSvnRepository
        - save_code_now:swh.loader.svn.tasks.MountAndLoadSvnRepository
        - save_code_now:swh.loader.svn.tasks.DumpMountAndLoadSvnRepository
        - save_code_now:swh.loader.package.archive.tasks.LoadTarball
      ackLate: true
      autoScaling:
        stopWhenNoActivity: false
        queueThreshold: 1
        minReplicaCount: 2
        maxReplicaCount: 2
      requestedMemory: 1024Mi
      requestedCpu: 100m
    maven:
      image: swh_loader_package_image
      queues:
        - swh.loader.package.maven.tasks.LoadMaven
      autoScaling:
        maxReplicaCount: 1
      requestedMemory: 600Mi
      requestedCpu: 500m
    mercurial:
      queues:
        - swh.loader.mercurial.tasks.LoadArchiveMercurial
        - swh.loader.mercurial.tasks.LoadMercurial
      autoScaling:
        maxReplicaCount: 1
      requestedMemory: 124Mi
      requestedCpu: 500m
    npm:
      requestedMemory: 256Mi
      requestedCpu: 200m
      image: swh_loader_package_image
      queues:
        - swh.loader.package.npm.tasks.LoadNpm
      autoScaling:
        maxReplicaCount: 1
    opam:
      image: swh_loader_package_image
      queues:
        - swh.loader.package.opam.tasks.LoadOpam
      autoScaling:
        maxReplicaCount: 1
      requestedMemory: 1024Mi
      requestedCpu: 1000m
    pypi:
      requestedMemory: 256Mi
      requestedCpu: 200m
      image: swh_loader_package_image
      queues:
        - swh.loader.package.pypi.tasks.LoadPyPI
      autoScaling:
        maxReplicaCount: 1
    pubdev:
      image: swh_loader_package_image
      queues:
        - swh.loader.package.pubdev.tasks.LoadPubDev
      autoScaling:
        maxReplicaCount: 1
      requestedMemory: 256Mi
      requestedCpu: 800m
    rpm:
      image: swh_loader_package_image
      queues:
        - swh.loader.package.rpm.tasks.LoadRpm
      autoScaling:
        maxReplicaCount: 1
      requestedMemory: 3072Mi
      requestedCpu: 1000m
    svn:
      queues:
        - swh.loader.svn.tasks.LoadSvnRepository
        - swh.loader.svn.tasks.MountAndLoadSvnRepository
        - swh.loader.svn.tasks.DumpMountAndLoadSvnRepository
      autoScaling:
        maxReplicaCount: 1
      requestedMemory: 6144Mi
      requestedCpu: 100m
      limitedMemory: 25600Mi

loader_metadata:
  enabled: true
  storageConfigurationRef: rpcRWStorageConfiguration
  schedulerConfigurationRef: remoteSchedulerConfiguration
  consumerGroup: loader_metadata.journal_client
  prefix: swh.journal.objects
  journalBrokers:
    secretName: swh-archive-broker-secret
    hosts:
      - journal1.internal.staging.swh.network:9094
    user: swh-archive-stg
  autoScaling:
    maxReplicaCount: 1
  requestedMemory: 200Mi
  requestedCpu: 500m

storage_replayer:
  enabled: true

  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: "swh/replayer"
            operator: In
            values:
            - "true"
  storageConfigurationRef: cassandraReplayerStorageConfiguration
  journalBrokers:
    hosts:
      - journal1.internal.staging.swh.network:9094
    user: swh-cassandra-stg
    groupIdName: cassandra
    secretName: swh-cassandra-broker-secret
  error_reporter:
    host: redis.redis
    port: 6379
    db: 1
  deployments:
    content:
      objects:
        - content
      privileged: true
      requestedCpu: 350m
      requestedMemory: 300Mi
      autoScaling:
        maxReplicaCount: 10
    directory:
      objects:
        - directory
      batchSize: 250
      privileged: true
      requestedCpu: 350m
      requestedMemory: 250Mi
      autoScaling:
        maxReplicaCount: 10
    extid:
      objects:
        - extid
      batchSize: 1000
      privileged: true
      # Full replay
      requestedCpu: 400m
      requestedMemory: 200Mi
      #Follow up consumption
      #requestedCpu: 50m
      autoScaling:
        maxReplicaCount: 5
    metadata:
      objects:
        - metadata_authority
        - metadata_fetcher
      privileged: true
      # follow up consumption
      requestedCpu: 50m
      requestedMemory: 100Mi
      autoScaling:
        maxReplicaCount: 5
    raw-extrinsic-metadata:
      objects:
        - raw_extrinsic_metadata
      batchSize: 250
      privileged: true
      # Full replay
      requestedCpu: 400m
      requestedMemory: 200Mi
      # follow up consumption
      #requestedCpu: 50m
      autoScaling:
        maxReplicaCount: 5
    origin:
      objects:
        - origin
      batchSize: 1000
      privileged: true
      # Full replay
      requestedCpu: 400m
      requestedMemory: 200Mi
      #Follow up consumption
      #requestedCpu: 50m
      autoScaling:
        maxReplicaCount: 5
    origin-visit:
      objects:
        - origin_visit
      batchSize: 1000
      privileged: true
      # Full replay
      requestedCpu: 400m
      requestedMemory: 400Mi
      #Follow up consumption
      #requestedCpu: 100m
      #requestedMemory: 100Mi
      autoScaling:
        maxReplicaCount: 5
    origin-visit-status:
      objects:
        - origin_visit_status
      batchSize: 1000
      privileged: true
      # Full replay
      requestedCpu: 500m
      requestedMemory: 300Mi
      #Follow up consumption
      #requestedCpu: 55m
      #requestedMemory: 200Mi
      autoScaling:
        maxReplicaCount: 5
    release:
      objects:
        - release
      batchSize: 1000
      privileged: true
      # Full replay
      requestedCpu: 600m
      requestedMemory: 300Mi
      # follow up consumption
      #requestedCpu: 50m
      autoScaling:
        maxReplicaCount: 5
    revision:
      objects:
        - revision
      batchSize: 1000
      privileged: true
      # Full replay
      requestedCpu: 750m
      requestedMemory: 750Mi
      # follow up consumption
      #requestedCpu: 50m
      #requestedMemory: 400Mi
      autoScaling:
        maxReplicaCount: 5
    skipped-content:
      objects:
        - skipped_content
      batchSize: 100
      privileged: true
      # Full replay
      requestedCpu: 300m
      requestedMemory: 400Mi
      # follow up consumption
      #requestedCpu: 50m
      autoScaling:
        maxReplicaCount: 5
    snapshot:
      objects:
        - snapshot
      batchSize: 250
      privileged: true
      # Full replay
      requestedCpu: 400m
      requestedMemory: 250Mi
      # follow up consumption
      #requestedCpu: 80m
      autoScaling:
        maxReplicaCount: 5

storage:
  enabled: true
  autoScaling:
    minReplicaCount: 2
    maxReplicaCount: 10
    cpuPercentageUsage: 150
  requestedCpu: 500m
  requestedMemory: 1500Mi

  storageConfigurationRef: cassandraStorageConfiguration

  # TODO: migrate this to a proper template
  objstorageClass: remote
  objstorageConfig:
    url: http://storage1.internal.staging.swh.network:5003/
  ingress:
    enabled: true
    host: storage-cassandra.internal.staging.swh.network
  gunicorn:
    threads: 4
    workers: 8
  journalWriter:
   brokers:
     - journal1.internal.staging.swh.network
     - journal2.internal.staging.swh.network
   clientId: swh.storage-cassandra.journal_writer.storage
   producerConfig: |-
     message.max.bytes: 1000000000

web:
  enabled: true
  logLevel: INFO
  replicas: 2
  requestedCpu: 500m
  requestedMemory: 500Mi
  #autoScaling:
  #  maxReplicaCount: 5
  configSecretRef: swh-cassandra-webapp-config
  host: webapp-cassandra.internal.staging.swh.network
  ingressAnnotations:
    cert-manager.io/cluster-issuer: letsencrypt-production-gandi
    kubernetes.io/ingress.class: nginx
    kubernetes.io/tls-acme: "true"
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
  tlsEnabled: true

graphql:
  enabled: true
  logLevel: DEBUG
  debug: yes
  sentry:
    enabled: true
  storageConfigurationRef: localRpcROStorageConfiguration
  searchConfiguration:
    host: search0.internal.staging.swh.network
    port: 5010
  replicas: 2
  gunicorn:
    threads: 4
    workers: 2
    timeout: 3600
  ingress:
    enabled: true
    httpPath: /graphql/
    host: webapp-cassandra.internal.staging.swh.network
  auth:
    # temporary disable the authentication to avoid a redirect error from keycloak
    enabled: false
    server: https://auth.softwareheritage.org/auth/
    realm: SoftwareHeritageStaging
    client: swh-web
    cacheUrl: memcached://memcached:11211
  maxRawContentSize: 10000

memcached:
  enabled: true
