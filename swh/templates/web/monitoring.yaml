{{ if .Values.web.enabled -}}
{{ range $web_type, $web_config := .Values.web.deployments }}
{{- /*  metricsScrapingEnabled defaults to true if not defined  */ -}}
{{- if and (or (not (hasKey $web_config "enabled")) (get $web_config "enabled"))
           (or (not (hasKey $web_config "metricsScrapingEnabled")) $web_config.metricsScrapingEnabled) -}}
---
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: web-{{ $web_type }}-metrics
  namespace: {{ $.Values.namespace }}
spec:
  endpoints:
  - path: /metrics/prometheus/
    port: rpc
    interval: 300s
    scrapeTimeout: 60s
  selector:
    matchLabels:
      app: web-{{ $web_type }}
  namespaceSelector:
    matchNames:
      - {{ $.Values.namespace }}
{{- end -}}
{{ end -}}
{{- end -}}
