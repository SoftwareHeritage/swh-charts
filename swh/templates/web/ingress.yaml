{{ if and .Values.web.enabled .Values.web.ingress.enabled -}}
{{- $defaultWhitelistSourceRange := .Values.web.ingress.whitelistSourceRange | default list -}}
{{- range $endpoint_definition, $endpoint_config := .Values.web.ingress.endpoints -}}
{{- $extraWhitelistSourceRange := get $endpoint_config "extraWhitelistSourceRange" | default list -}}
{{- $whitelistSourceRange := join "," (concat $defaultWhitelistSourceRange $extraWhitelistSourceRange) | default "" -}}
{{- $paths := get $endpoint_config "paths" -}}
{{- $authenticated := get $endpoint_config "authentication" -}}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  namespace: {{ $.Values.namespace }}
  name: swh-web-ingress-{{ $endpoint_definition }}
  annotations:
  {{- if $.Values.web.ingress.extraAnnotations }}
    {{- toYaml $.Values.web.ingress.extraAnnotations | nindent 4 }}
  {{- end }}
  {{- if $whitelistSourceRange }}
    nginx.ingress.kubernetes.io/whitelist-source-range: {{ $whitelistSourceRange }}
  {{- end }}
  {{- if $authenticated }}
    # type of authentication
    nginx.ingress.kubernetes.io/auth-type: basic
    # an htpasswd file in the key auth within the secret
    nginx.ingress.kubernetes.io/auth-secret-type: auth-file
    # name of the secret that contains the user/password definitions
    nginx.ingress.kubernetes.io/auth-secret: {{ $authenticated }}
    # message to display with an appropriate context why the authentication is required
    nginx.ingress.kubernetes.io/auth-realm: 'Authentication Required'
  {{- end }}
spec:
  {{- if $.Values.web.ingressClassName }}
  ingressClassName: {{ $.Values.web.ingressClassName }}
  {{- end }}
  rules:
  - host: {{ $.Values.web.host }}
    http:
      paths:
      {{- range $path_config := $paths }}
      {{- $port := get $path_config "port" | default 5004 }}
      - path: {{ get $path_config "path" }}
        pathType: Prefix
        backend:
          service:
            name: web
            port:
              number: {{ $port }}
      {{ end }}
  {{- if $.Values.web.ingress.tlsEnabled }}
  tls:
  - hosts:
    - {{ $.Values.web.host }}
    secretName: swh-web-crt
  {{- end }}
{{ end }}
{{ end }}
