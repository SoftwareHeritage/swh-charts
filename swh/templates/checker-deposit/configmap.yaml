{{ if .Values.checker_deposit.enabled -}}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: checker-deposit-template
  namespace: {{ $.Values.namespace }}
data:
  config.yml.template: |
    extraction_dir: "/tmp/swh.checker.deposit/"
    storage:
      cls: remote
      url: http://{{ .Values.checker_deposit.storage.host }}:{{ .Values.checker_deposit.storage.port }}/
    celery:
      task_broker: amqp://${AMQP_USERNAME}:${AMQP_PASSWORD}@{{ .Values.checker_deposit.amqp.host }}:{{ .Values.checker_deposit.amqp.port }}/
      task_acks_late: true
      task_modules:
      - swh.deposit.loader.tasks
      task_queues:
      - swh.deposit.loader.tasks.ChecksDepositTsk
    deposit:
      url: https://{{ .Values.checker_deposit.deposit.host }}/1/private/
      auth:
        username: ${DEPOSIT_USERNAME}
        password: ${DEPOSIT_PASSWORD}
  init-container-entrypoint.sh: |
    #!/bin/bash

    set -e

    CONFIG_FILE=/etc/swh/config.yml

    # substitute environment variables when creating the default config.yml
    eval echo \""$(</etc/swh/configuration-template/config.yml.template)"\" \
      > $CONFIG_FILE

    exit 0
{{ end }}
