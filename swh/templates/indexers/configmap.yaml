{{ if .Values.indexers.enabled -}}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: indexer-utils
  namespace: {{ $.Values.namespace }}
data:
  pre-stop-idempotent.sh: |
    #!/bin/bash

    # pre-stop hook can be triggered multiple times but we want it to be applied only
    # once so container can warm-shutdown properly.

    # When celery receives multiple times the sigterm signal, this ends up doing an
    # immediate shutdown which prevents long-standing tasks to finish properly.

    set -ex

    WITNESS_FILE=/tmp/already-stopped

    # to support near-immediate concurrent calls
    sleep $(echo | awk '{print rand()})

    if [ ! -e $WITNESS_FILE ]; then
      touch $WITNESS_FILE
      kill 1
    fi

{{ range $indexer_type, $deployment_config := .Values.indexers.deployments }}
{{ $indexer_name := ( print "indexer-" $indexer_type ) }}
{{- $journalUser := $.Values.indexers.journalBrokers.user -}}
{{- $consumerGroup := get $deployment_config "consumerGroup" -}}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $indexer_name }}-template
  namespace: {{ $.Values.namespace }}
data:
  config.yml.template: |
    storage:
      cls: pipeline
      steps:
      - cls: retry
      - cls: remote
        url: http://{{ $.Values.indexers.storage.host }}:{{ $.Values.indexers.storage.port }}/
    indexer_storage:
      cls: remote
      url: http://{{ $.Values.indexers.indexer_storage.host }}:{{ $.Values.indexers.indexer_storage.port }}/
    objstorage:
      cls: remote
      url: http://{{ $.Values.indexers.objstorage.host }}:{{ $.Values.indexers.objstorage.port }}/
    journal:
      brokers: {{ toYaml $.Values.indexers.journalBrokers.hosts | nindent 8 }}
      {{ if $journalUser }}
      group_id: {{ $journalUser }}-{{ $consumerGroup }}
      {{ else }}
      group_id: {{ $consumerGroup }}
      {{ end -}}
      prefix: {{ get $deployment_config "prefix" }}
      {{ if $deployment_config.batch_size }}
      batch_size: {{ $deployment_config.batch_size }}
      {{ end -}}

      {{ if $journalUser }}
      sasl.mechanism: SCRAM-SHA-512
      security.protocol: SASL_SSL
      sasl.username: {{ $journalUser }}
      sasl.password: ${JOURNAL_PASSWORD}
      {{ end -}}

    {{- if $deployment_config.extraConfig -}}
      {{- range $option, $value := $deployment_config.extraConfig }}
    {{ $option }}: {{ toYaml $value | nindent 6 }}
      {{- end }}
    {{- end }}

  init-container-entrypoint.sh: |
    #!/bin/bash

    set -e

    CONFIG_FILE=/etc/swh/config.yml

    # substitute environment variables when creating the default config.yml
    eval echo \""$(</etc/swh/configuration-template/config.yml.template)"\" \
      > $CONFIG_FILE

    exit 0
{{ end }}
{{- end -}}
