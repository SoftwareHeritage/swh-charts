{{ if .Values.indexers.enabled -}}
{{- $namespace := .Values.namespace -}}
{{- $journalUser := .Values.indexers.journalBrokers.user -}}
{{- $secretName := .Values.indexers.journalBrokers.secretName -}}
{{- range $indexer_type, $deployment_config := .Values.indexers.deployments -}}
{{- $autoscalingConfig := get $deployment_config "autoScaling" -}}
{{- if and $autoscalingConfig $secretName }}
---
apiVersion: v1
kind: Secret
metadata:
  name: keda-indexers-kafka-secrets-{{ $indexer_type }}
  namespace: {{ $namespace }}
type: Opaque
stringData:
  sasl: "scram_sha512"
  username: {{ $journalUser }}
  tls: "enable"
---
apiVersion: keda.sh/v1alpha1
kind: TriggerAuthentication
metadata:
  name: keda-indexers-trigger-authentication-{{ $indexer_type }}
  namespace: {{ $namespace }}
spec:
  secretTargetRef:
  - parameter: sasl
    name: keda-indexers-kafka-secrets-{{ $indexer_type }}
    key: sasl
  - parameter: username
    name: keda-indexers-kafka-secrets-{{ $indexer_type }}
    key: username
  - parameter: tls
    name: keda-indexers-kafka-secrets-{{ $indexer_type }}
    key: tls
  - parameter: password
    name: {{ $secretName }}
    key: BROKER_USER_PASSWORD
{{ end }}
{{ end }}
{{- end -}}
