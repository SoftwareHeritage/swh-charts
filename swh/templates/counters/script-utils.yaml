{{- if and .Values.counters.enabled .Values.counters.refreshCountersCache.enabled -}}
{{- $configuration := get .Values .Values.counters.refreshCountersCache.countersConfigurationRef -}}
{{- $host := get $configuration "url" }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: script-utils
  namespace: {{ $.Values.namespace }}
data:
  refresh-counters-cache.sh: |
    #!/bin/bash

    set -e

    cache_file=$1
    static_file=$2

    static_file_stanza=""
    if [ -n "${static_file}" ]; then
        static_file_stanza=", \"static_file\": \"${static_file}\""
    fi

    tmp_file=$(mktemp)

    trap "rm -f ${tmp_file}" EXIT

    cat >"${tmp_file}" <<EOF
    {
        "cache_file": "${cache_file}",
        "objects": ["content", "origin", "revision"]
        ${static_file_stanza}
    }
    EOF

    curl -s -XPOST -H 'Content-Type: application/json' {{ $host }}/refresh_history -d @"${tmp_file}"

  fetch-static-history.sh: |
    #!/bin/bash

    set -e

    DEST_DIR=/srv/softwareheritage/counters
    DEST_PATH="${DEST_DIR}/static_history.json"

    [ ! -d $DEST_DIR ] && mkdir -p $DEST_DIR

    url="https://gitlab.softwareheritage.org/swh/infra/puppet/puppet-swh-site/-/raw/production/site-modules/profile/files/swh/deploy/counters/static_history/static_history.json?ref_type=heads&inline=false"

    [ ! -f $DEST_PATH ] && curl -s $url > $DEST_PATH

{{- end -}}
