{{- if and .Values.counters.enabled .Values.counters.refreshCountersCache.enabled -}}
{{- $configuration := get .Values .Values.counters.refreshCountersCache.countersConfigurationRef -}}
{{- $host := get $configuration "url" }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: script-utils
  namespace: {{ $.Values.namespace }}
data:
  refresh-counters-cache.sh: |
    #!/bin/bash

    set -ex

    cache_file=$1
    static_file=$2

    static_file_stanza=""
    if [ -n "${static_file}" ]; then
        static_file_stanza=", \"static_file\": \"${static_file}\""
    fi

    tmp_file=$(mktemp)

    trap "rm -f ${tmp_file}" EXIT

    cat >"${tmp_file}" <<EOF
    {
        "cache_file": "${cache_file}",
        "objects": ["content", "origin", "revision"]
        ${static_file_stanza}
    }
    EOF

    curl -s -XPOST -H 'Content-Type: application/json' {{ $host }}/refresh_history -d @"${tmp_file}"

  fetch-static-history.sh: |
    #!/bin/bash

    set -ex

    apt update
    apt install -y curl

    static_history_path=$1

    url="https://gitlab.softwareheritage.org/swh/devel/swh-counters/-/snippets/1617/raw/main/snippetfile1.txt?inline=false"

    curl -s $url > $static_history_path

{{- end -}}
