{{ if .Values.loader_metadata.enabled -}}
{{- $journalUser := .Values.loader_metadata.journalBrokers.user -}}
{{- $consumerGroup := .Values.loader_metadata.consumerGroup -}}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: loader-metadata-template
  namespace: {{ .Values.namespace }}
data:
  config.yml.template: |
    {{- include "swh.storageConfiguration" (dict "configurationRef" .Values.loader_metadata.storageConfigurationRef
                                                 "Values" .Values) | nindent 4 }}

    {{- include "swh.schedulerConfiguration" (list .Values .Values.loader_metadata.schedulerConfigurationRef) | nindent 4 }}

    journal:
      brokers: {{ toYaml .Values.loader_metadata.journalBrokers.hosts | nindent 8 }}
      group_id: {{ $journalUser }}-{{ $consumerGroup }}
      prefix: {{ .Values.loader_metadata.prefix }}
      sasl.mechanism: SCRAM-SHA-512
      security.protocol: SASL_SSL
      sasl.username: {{ $journalUser }}
      sasl.password: ${BROKER_USER_PASSWORD}
    reload_after_days: {{ .Values.loader_metadata.reload_after_days | default 120 }}
    metadata_fetcher_credentials:

  init-container-entrypoint.sh: |
    #!/bin/bash

    set -e

    CONFIG_FILE=/etc/swh/config.yml

    # substitute environment variables when creating the default config.yml
    eval echo \""$(</etc/swh/configuration-template/config.yml.template)"\" \
      > $CONFIG_FILE

    CREDS_PATH=/etc/credentials/metadata-fetcher/credentials
    [ -f $CREDS_PATH ] && \
      sed 's/^/  /g' $CREDS_PATH >> $CONFIG_FILE

    exit 0
{{ end }}
