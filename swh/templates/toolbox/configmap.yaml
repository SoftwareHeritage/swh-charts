{{ if .Values.toolbox.enabled -}}
{{- $namespace := .Values.namespace -}}
{{- range $service_type, $deployment_config := .Values.toolbox.configs -}}
{{- $prefix_service_type_name := eq $service_type "indexer-storage" | ternary "indexerStorage" $service_type -}}
{{- $serviceConfigurationRef := print $prefix_service_type_name "ConfigurationRef" -}}
{{- $service_type_name := eq $service_type "indexer-storage" | ternary "indexer_storage" $service_type -}}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: toolbox-{{ $service_type }}-template
  namespace: {{ $namespace }}
data:
  config.yml.template: |
    {{ include "swh.postgresql" (dict "serviceType" $service_type_name
                                      "configurationRef" (get $deployment_config $serviceConfigurationRef)
                                      "Values" $.Values) | nindent 4 }}
    {{- if ( eq "scheduler" $service_type ) }}
      {{- include "celery.configuration" (dict "configurationRef" $deployment_config.celeryConfigurationRef
                                               "Values" $.Values) | nindent 4 }}
    {{ end }}
    {{- if ( eq "scrubber" $service_type ) }}
      {{- include "swh.postgresql" (dict "configurationRef" $deployment_config.storageConfigurationRef
                                         "serviceType" "storage"
                                         "Values" $.Values) | nindent 4 }}
      {{- include "swh.journalClientConfiguration" (dict "configurationRef" $deployment_config.journalClientConfigurationRef
                                                         "overrides" (dict "group_id" "changeme")
                                                         "Values" $.Values) | nindent 4 }}
    {{ end }}
{{ end }}
{{- end -}}
