{{ if .Values.storage_replayer.enabled -}}
{{- $error_reporter := .Values.storage_replayer.error_reporter }}
{{- range $deployment, $deployment_config := .Values.storage_replayer.deployments -}}
{{- $storageConfigIndent := ternary "    " "" $.Values.storage_replayer.pipelineFilterRetry }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: {{ $.Values.namespace }}
  name: storage-replayer-configuration-{{ $deployment }}-template
data:
  config.yml.template: |
    storage:
    {{- with $.Values.storage_replayer }}
      {{- if not .pipelineFilterRetry }}
      cls: {{ .storageClass }}
      {{- else if .pipelineFilterRetry }}
      cls: pipeline
      steps:
        - cls: filter
        - cls: retry
        - cls: {{ .storageClass }}
      {{- end }}
    {{- end }}
    {{- if eq $.Values.storage_replayer.storageClass "cassandra" }}
      {{- with $.Values.storage_replayer.cassandra }}
      {{ $storageConfigIndent }}hosts:
        {{- range $seed := .seeds }}
      {{ $storageConfigIndent }}  - {{ $seed }}
        {{- end }}
      {{ $storageConfigIndent }}keyspace: {{ .keySpace }}
      {{ $storageConfigIndent }}consistency_level: {{ .consistencyLevel }}
      {{- end }}
    {{- else if eq $.Values.storage_replayer.storageClass "postgresql" }}
      {{- with $.Values.storage_replayer.postgresql }}
      {{ $storageConfigIndent }}db: host={{ .host }} port={{ .port | default "5432" }} user={{ .user | default "guest" }} dbname={{ .db | default "swh" }} password=${POSTGRESQL_PASSWORD}
      {{- end }}
    {{- end }}
    {{- if $deployment_config.specific_options -}}
      {{- range $option, $value := $deployment_config.specific_options }}
      {{ $storageConfigIndent }}{{ $option }}: {{ $value }}
      {{- end }}
    {{- end }}
    {{ $storageConfigIndent }}  objstorage:
    {{ $storageConfigIndent }}    cls: noop

    journal_client:
      cls: kafka
      brokers:
      {{- range $broker := $.Values.storage_replayer.journalBrokers.hosts }}
        - {{ $broker }}
      {{- end }}
      sasl.username: {{ $.Values.storage_replayer.journalBrokers.user }}
      sasl.password: ${BROKER_USER_PASSWORD}
      security.protocol: sasl_ssl
      sasl.mechanism: SCRAM-SHA-512
      # The prefix must match the username
      group_id: {{ $.Values.storage_replayer.journalBrokers.user }}-{{ $.Values.storage_replayer.storageClass }}-replayer-{{ $deployment }}
      batch_size: {{ get $deployment_config "batchSize" | default "200" }}
      message.max.bytes: {{ $.Values.storage_replayer.maxMessagesBytes }}
      privileged: {{ get $deployment_config "privileged" | default "false" }}
      object_types:
      {{- range $object := get $deployment_config "objects" }}
        - {{ $object }}
      {{- end }}
    {{- if $error_reporter }}
    replayer:
      error_reporter:
      {{- range $option, $value := $error_reporter }}
        {{ $option }}: {{ $value }}
      {{- end }}
    {{- end }}
{{ end }}
{{- end -}}
