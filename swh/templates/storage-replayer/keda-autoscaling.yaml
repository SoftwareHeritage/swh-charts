{{ if .Values.storageReplayer.enabled -}}
{{- $secretName := .Values.storageReplayer.journalBrokers.secretName -}}
{{- $secrets := .Values.storageReplayer.journalBrokers.secrets -}}
{{- if or $secretName $secrets }}
{{- range $deployment, $deployment_config := .Values.storageReplayer.deployments -}}
{{- if or (not (hasKey $deployment_config "enabled")) (get $deployment_config "enabled") -}}
{{ if get $deployment_config "autoScaling" }}
{{- $autoscalingConfig := get $deployment_config "autoScaling" -}}
{{- $user := $.Values.storageReplayer.journalBrokers.user -}}
{{- $prefixGroupId := required "groupIdName not specified" $.Values.storageReplayer.journalBrokers.groupIdName -}}
{{- $suffixGroupId := print "replayer-" $deployment -}}
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: storage-replayer-{{ $deployment }}-scaledobject
  namespace: {{ $.Values.namespace }}
spec:
  scaleTargetRef:
    name: storage-replayer-{{ $deployment }}
  pollingInterval: {{ get $autoscalingConfig "poolInterval" | default 120 }}
  minReplicaCount: {{ get $autoscalingConfig "minReplicaCount" | default 1 }}
  maxReplicaCount: {{ get $autoscalingConfig "maxReplicaCount" | default 5 }}
  triggers:
  - type: kafka
    metadata:
      bootstrapServers: {{ join "," $.Values.storageReplayer.journalBrokers.hosts }}
      {{- if $user }}
      consumerGroup: {{ $user }}-{{ $prefixGroupId }}-{{ $suffixGroupId }}
      {{- else }}
      consumerGroup: {{ $prefixGroupId }}-{{ $suffixGroupId }}
      {{- end }}
      lagThreshold: {{ get $autoscalingConfig "lagThreshold" | default 1000 | quote }}
      offsetResetPolicy: earliest
    authenticationRef:
      name: keda-storage-replayer-trigger-authentication
{{ end }}
{{ end }}
{{ end }}
{{ end }}
{{- end -}}
