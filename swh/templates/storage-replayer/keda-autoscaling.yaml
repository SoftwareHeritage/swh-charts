{{ if .Values.storage_replayer.enabled -}}
{{- $secretName := .Values.storage_replayer.journalBrokers.secretName -}}
{{- $secrets := .Values.storage_replayer.journalBrokers.secrets -}}
{{- if or $secretName $secrets }}
{{- range $deployment, $deployment_config := .Values.storage_replayer.deployments -}}
{{- if or (not (hasKey $deployment_config "enabled")) (get $deployment_config "enabled") -}}
{{ if get $deployment_config "autoScaling" }}
{{- $autoscalingConfig := get $deployment_config "autoScaling" -}}
---
apiVersion: keda.sh/v1alpha1
kind: ScaledObject
metadata:
  name: storage-replayer-{{ $deployment }}-scaledobject
  namespace: {{ $.Values.namespace }}
spec:
  scaleTargetRef:
    name: storage-replayer-{{ $deployment }}
  pollingInterval: {{ get $autoscalingConfig "poolInterval" | default 120 }}
  minReplicaCount: {{ get $autoscalingConfig "minReplicaCount" | default 1 }}
  maxReplicaCount: {{ get $autoscalingConfig "maxReplicaCount" | default 5 }}
  triggers:
  - type: kafka
    metadata:
      bootstrapServers: {{ join "," $.Values.storage_replayer.journalBrokers.hosts }}
      consumerGroup: {{ $.Values.storage_replayer.journalBrokers.user }}-{{ required "groupIdName not specified" $.Values.storage_replayer.journalBrokers.groupIdName }}-replayer-{{ $deployment }}
      lagThreshold: {{ get $autoscalingConfig "lagThreshold" | default 1000 | quote }}
      offsetResetPolicy: earliest
    authenticationRef:
      name: keda-storage-replayer-trigger-authentication
{{ end }}
{{ end }}
{{ end }}
{{ end }}
{{- end -}}
