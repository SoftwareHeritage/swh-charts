{{ define "swh.storageReplayer.configmap" }}
{{- $user := .Values.storageReplayer.journalBrokers.user -}}
{{- $prefixGroupId := required "groupIdName not specified" .Values.storageReplayer.journalBrokers.groupIdName -}}
{{- $suffixGroupId := print "replayer-" .deployment -}}
---
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: {{ .Values.namespace }}
  name: storage-replayer-configuration-{{ .deployment }}-template
data:
  config.yml.template: |
    {{- include "swh.storageConfiguration" (dict "configurationRef" .Values.storageReplayer.storageConfigurationRef
                                                 "Values" .Values) | nindent 4 }}

    journal_client:
      cls: kafka
      brokers:
      {{- range $broker := .Values.storageReplayer.journalBrokers.hosts }}
        - {{ $broker }}
      {{- end }}
      {{- if $user }}  # Optional authentication
      sasl.username: {{ $user }}
      sasl.password: ${BROKER_USER_PASSWORD}
      security.protocol: sasl_ssl
      sasl.mechanism: SCRAM-SHA-512
      # The (group id) prefix must match the username
      group_id: {{ $user }}-{{ $prefixGroupId }}-{{ $suffixGroupId }}
      {{- else }}
      group_id: {{ $prefixGroupId }}-{{ $suffixGroupId }}
      {{- end }}
      batch_size: {{ get .deployment_config "batchSize" | default "200" }}
      message.max.bytes: {{ .Values.storageReplayer.maxMessagesBytes }}
      privileged: {{ get .deployment_config "privileged" | default "false" }}
      object_types:
      {{- range $object := get .deployment_config "objects" }}
        - {{ $object }}
      {{- end }}
    {{- if .Values.storageReplayer.error_reporter }}
    replayer:
      error_reporter:
      {{- range $option, $value := .Values.storageReplayer.error_reporter }}
        {{ $option }}: {{ $value }}
      {{- end }}
    {{- end }}

{{ end }}
