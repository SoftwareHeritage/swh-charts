{{- if and .Values.vault.enabled .Values.vault.ingress.enabled -}}
{{- $defaultWhitelistSourceRange := .Values.vault.ingress.whitelistSourceRange | default list -}}
{{- range $ingress_definition, $ingress_config := .Values.vault.ingress.ingressDefinitions -}}
{{- $extraWhitelistSourceRange := get $ingress_config "extraWhitelistSourceRange" | default list -}}
{{- $whitelistSourceRange := join "," (concat $defaultWhitelistSourceRange $extraWhitelistSourceRange) | default "" -}}
{{- $paths := get $ingress_config "paths" -}}
---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  namespace: {{ $.Values.namespace }}
  name: vault-rpc-ingress-{{ $ingress_definition }}
  annotations:
  {{- if $whitelistSourceRange }}
    nginx.ingress.kubernetes.io/whitelist-source-range: {{ $whitelistSourceRange }}
  {{- end }}
{{ toYaml $.Values.vault.ingress.extraAnnotations | indent 4 }}

spec:
  {{- if $.Values.vault.ingress.className }}
  ingressClassName: {{ $.Values.vault.ingress.className }}
  {{- end }}
  rules:
  - host: {{ $.Values.vault.ingress.host }}
    http:
      paths:
{{- range $path := $paths }}
      - path: {{ $path }}
        pathType: Prefix
        backend:
          service:
            name: vault-rpc
            port:
              number: 5005
{{ end }}
{{ end }}
{{ end }}
