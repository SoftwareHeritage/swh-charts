{{ if .Values.listers.enabled -}}
{{- range $lister_type, $deployment_config := .Values.listers.deployments -}}
{{- $lister_name := ( print "lister-" $lister_type ) -}}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $lister_name }}-template
  namespace: {{ $.Values.namespace }}
data:
  config.yml.template: |
    storage:
      cls: remote
      url: http://{{ $.Values.listers.storage.host }}:{{ $.Values.listers.storage.port }}/
    scheduler:
      cls: remote
      url: http://{{ $.Values.listers.scheduler.host }}:{{ $.Values.listers.scheduler.port }}/
    celery:
      task_broker: amqp://${AMQP_USERNAME}:${AMQP_PASSWORD}@{{ $.Values.loaders.amqp.host }}:{{ $.Values.loaders.amqp.port }}/
      task_acks_late: true
      task_queues:
    {{- range $queue := get $deployment_config "queues" }}
      - {{ $queue }}
    {{- end }}
    credentials:
  init-container-entrypoint.sh: |
    #!/bin/bash

    set -e

    CONFIG_FILE=/etc/swh/config.yml

    # substitute environment variables when creating the default config.yml
    eval echo \""$(</etc/swh/configuration-template/config.yml.template)"\" \
      > $CONFIG_FILE

    CREDS_LISTER_PATH=/etc/credentials/listers/credentials
    [ -f $CREDS_LISTER_PATH ] && \
      sed 's/^/  /g' $CREDS_LISTER_PATH >> $CONFIG_FILE

    exit 0
{{ end }}
{{- end -}}
