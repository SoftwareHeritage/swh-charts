{{ if .Values.listers.enabled -}}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: lister-utils
  namespace: {{ $.Values.namespace }}
data:
  pre-stop-idempotent.sh: |
    #!/bin/bash

    # pre-stop hook can be triggered multiple times but we want it to be applied only
    # once so container can warm-shutdown properly.

    # When celery receives multiple times the sigterm signal, this ends up doing an
    # immediate shutdown which prevents long-standing tasks to finish properly.

    set -ex

    WITNESS_FILE=/tmp/already-stopped

    # Seed awk with the number of nanoseconds since epoch
    # and have it generate a number between 0 and 1
    sleep $(date +%s%N | awk '{srand($1); print rand()}')

    if [ ! -e $WITNESS_FILE ]; then
      touch $WITNESS_FILE
      kill 1
    fi

{{ range $lister_type, $deployment_config := .Values.listers.deployments }}
{{ $lister_name := ( print "lister-" $lister_type ) }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ $lister_name }}-template
  namespace: {{ $.Values.namespace }}
data:
  config.yml.template: |
    storage:
      cls: remote
      url: http://{{ $.Values.listers.storage.host }}:{{ $.Values.listers.storage.port }}/
    scheduler:
      cls: remote
      url: http://{{ $.Values.listers.scheduler.host }}:{{ $.Values.listers.scheduler.port }}/

    {{- if $deployment_config.extraConfig -}}
      {{- range $option, $value := $deployment_config.extraConfig }}
    {{ $option }}: {{ toYaml $value | nindent 6 }}
      {{- end }}
    {{- end }}

    celery:
      task_broker: amqp://${AMQP_USERNAME}:${AMQP_PASSWORD}@{{ $.Values.loaders.amqp.host }}:{{ $.Values.loaders.amqp.port }}/
      task_acks_late: true
      task_queues:
    {{- range $queue := get $deployment_config "queues" }}
      - {{ $queue }}
    {{- end }}
      sentry_settings_for_celery_tasks:
        __sentry-settings-for-celery-tasks__
    credentials:
      __lister-credentials__
  init-container-entrypoint.sh: |
    #!/bin/bash

    set -e

    CONFIG_FILE=/etc/swh/config.yml
    CONFIG_FILE_WIP=/tmp/wip-config.yml

    # substitute environment variables when creating the default config.yml
    eval echo \""$(</etc/swh/configuration-template/config.yml.template)"\" \
      > $CONFIG_FILE

    SENTRY_SETTINGS_PATH=/etc/credentials/sentry-settings/sentry_settings_for_celery_tasks
    if [ -f $SENTRY_SETTINGS_PATH ]; then
      awk "/__sentry-settings-for-celery-tasks__/{system(\"sed 's/^/    /g' $SENTRY_SETTINGS_PATH\");next}1" $CONFIG_FILE > $CONFIG_FILE_WIP
      mv $CONFIG_FILE_WIP $CONFIG_FILE
    else
      sed -i '/__sentry-settings-for-celery-tasks__//g' $CONFIG_FILE
    fi

    if [ -f $CREDS_LISTER_PATH ]; then
      awk "/__lister-credentials__/{system(\"sed 's/^/  /g' $CREDS_LISTER_PATH\");next}1" $CONFIG_FILE > $CONFIG_FILE_WIP
      mv $CONFIG_FILE_WIP $CONFIG_FILE
    else
      sed -i '/__lister-credentials__//g' $CONFIG_FILE
    fi

    exit 0
{{ end }}
{{- end -}}
