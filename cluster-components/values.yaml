---
# Main common configuration for the chart.
namespace: cluster-components

# All applications whose 'enabled' flag is false by default are applications that are
# already installed in the cluster by the main swh provisioning except for the clusters
# minikube (local dev) and rancher (admin cluster).
cert-manager:
  enabled: false
  # Supported in the chart, not seen on the pods...
  priorityClassName: cluster-components-system

prometheus:
  enabled: false
  # Not working somehow... Charts reference it but it's not seen in minikube
  priorityClassName: cluster-components-system
  namespaceOverride: cattle-monitoring-system
  grafana:
    namespaceOverride: cattle-monitoring-system
  prometheus-node-exporter:
    namespaceOverride: cattle-monitoring-system
  kube-state-metrics:
    namespaceOverride: cattle-monitoring-system

# This configuration is swh specific (and independent from the prometheus configuration
# already done during terraform provisioning). When activated, this allows to relay the
# cluster's prometheus alerts to the cluster admin's alertmanager ingress irc relay
alertmanagerConfig:
  enabled: false
  namespace: cattle-monitoring-system
  ircRelayHost: https://alertmanager-irc-relay.internal.admin.swh.network/swh-sysadm
  # .htaccess or authentication credentials
  authentication:
    enabled: true
    secretRef: alertmanager-irc-relay-config
    userKeyRef: user
    passwordKeyRef: password
  # inhibitorRules:
  #   - targetMatch:
  #     - name: mylabel
  #       value: myvalue
  #     ...

alertmanagerIrcRelay:
  enabled: false
  priorityClassName: cluster-components-system
  ingress:
    enabled: true
    hosts:
      - alertmanager-irc-relay.admin.swh.network
      - alertmanager-irc-relay.internal.admin.swh.network
    # secret holding the .htpasswd information
    authentication: ingress-nginx/basic-auth
    tls:
      enabled: true
      # clusterIssuer: letsencrypt-production
  http_port: 8000
  # Room to connect to
  room: swh-sysadm
  # requestedMemory: "128Mi"
  # requestedCpu: "500"
  # optional
  # limitedMemory: "256Mi"
  # limitedCpu: "1000"

blackboxExporter:
  enabled: false
  priorityClassName: cluster-components-system
  nameOverride: blackbox-exporter
  namespaceOverride: cattle-monitoring-system
  serviceMonitor:
    enabled: true
    selfMonitor:
      enabled: true
    prometheusRule:
      enabled: true
  pspEnabled: false
  config:
    modules:
      swh_www:
        prober: http
        timeout: 5s
        http:
          valid_http_versions: ["HTTP/1.1", "HTTP/2.0"]
          follow_redirects: true
          preferred_ip_protocol: "ip4"
          fail_if_body_not_matches_regexp:
            - '<title>Software Heritage</title>'

podPriority:
  enabled: false
  priorities:
    cluster-components-system:
      range: 50000-100000
      value: 75000
      description: Highest pod priorities (ingress, operator, collector, controller)

svix:
  enabled: false
  ingress:
    host: svix.example.org
    createTLS: true
  requestedMemory: 100Mi
  requestedCpu: 100m
  namespace: svix-server
  postgres:
    requestedMemory: 100Mi
    requestedCpu: 100m
    persistentVolume: false
  redis:
    requestedMemory: 100Mi
    requestedCpu: 100m
    persistentVolume: false

alerting:
  enabled: false
  period:
    tinyDelay: 5m
    smallDelay: 15m
  cassandra:
    unrepairedSize: 214748364800

scrapeExternalMetrics:
  enabled: false
  interval: 30s
  deployments:
    # rabbitmq:
    #   interval: 60s
    #   namespace: rabbitmq
    #   port: 9419
    #   ips:
    #     - 192.168.130.50
    # cassandra:
    #   namespace: cassandra
    #   metricsName: jmx
    #   serviceMonitorName: cassandra-jmx-exporter
    #   port: 7070
    #   ips:
    #     - 192.168.130.181
    #     - 192.168.130.182
    #     - 192.168.130.183

# Configuration for the local docker registry cache
dockerCache:
  enabled: false
  priorityClassName: cluster-components-system
  namespace: docker-cache
  ingress:
    hosts:
      - docker-cache.admin.swh.network
    tls:
      enabled: false
      # clusterIssuer: letsencrypt-production
  imageName: registry
  imageVersion: latest
  imagePullPolicy: Always
  storageRequest: 10Gi
  storageClassName: ceph-rbd
  metrics:
    enabled: true
  instances:
    docker.io:
      enabled: true
      remoteUrl: https://registry-1.docker.io
      # httpPrefix: /docker.io/
      # storageRequest: 5Gi
      # storageClassName: ceph-cephfs
    swh:
      enabled: true
      remoteUrl: https://container-registry.softwareheritage.org
    registry.k8s.io:
      enabled: true
      # metrics:
      #   enabled:
      #     false
    quay.io:
      enabled: false
    ghcr.io:
      enabled: false
