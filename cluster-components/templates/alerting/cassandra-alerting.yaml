{{ if .Values.alerting.enabled -}}
{{ with .Values.alerting.cassandra -}}
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    app: cassandra
  name: critical-cassandra-service.rules
  namespace: cattle-monitoring-system
spec:
  groups:
  - name: critical-cassandra-service.rules
    rules:
    - alert: Cassandra_Service_Degraded_In_{{ .environment | title }}
      annotations:
        description: "The {{"{{"}} $labels.instance {{"}}"}} node is unreachable for more than {{ trimSuffix "m" .period.down }} minutes. This node seems down."
        summary: "The {{"{{"}} $labels.service {{"}}"}} is degraded. Please check the {{"{{"}} $labels.instance {{"}}"}} status."
      expr: up{service="cassandra-servers-svc"} == 0
      for: {{ .period.down }}
      labels:
        severity: warning
        namespace: cattle-monitoring-system
    - alert: Cassandra_Table_Unrepaired_In_{{ .environment | title }}
      annotations:
        description: "The unrepaired bytes of table {{"{{"}} $labels.table {{"}}"}} is more than {{ div .unrepairedSize 1073741824 }} Gb."
        summary: "Please trigger a repair on the table {{"{{"}} $labels.table {{"}}"}} in keyspace {{"{{"}} $labels.keyspace {{"}}"}}."
      expr: sum by (keyspace, table) (cassandra_table_bytesunrepaired{table!="",job="cassandra-servers-svc"}) > {{ .unrepairedSize }}
      for: {{ .period.unrepaired }}
      labels:
        severity: critical
        namespace: cattle-monitoring-system
{{- end }}
{{- end }}
