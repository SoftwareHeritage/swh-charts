{{ if .Values.alerting.enabled -}}
{{ with .Values.alerting -}}
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: swh-{{ .environment }}.rules
  namespace: cattle-monitoring-system
spec:
  groups:
  - name: swh-{{ .environment }}.rules
    rules:
    - alert: Cassandra_Degraded_Service_In_{{ .environment | title }}
      annotations:
        description: "The {{"{{"}} $labels.instance {{"}}"}} node is unreachable for more than {{ trimSuffix "m" .period.smallDelay }} minutes. This node seems down."
        summary: "The {{"{{"}} $labels.service {{"}}"}} is degraded. Please check the {{"{{"}} $labels.instance {{"}}"}} status."
      expr: up{service="cassandra-servers-svc"} == 0
      for: {{ .period.smallDelay }}
      labels:
        severity: warning
        namespace: cattle-monitoring-system
    - alert: Cassandra_Unrepaired_Table_In_{{ .environment | title }}
      annotations:
        description: "The unrepaired bytes of table {{"{{"}} $labels.table {{"}}"}} is more than {{ div .cassandra.unrepairedSize 1073741824 }} Gb."
        summary: "Please trigger a repair on the table {{"{{"}} $labels.table {{"}}"}} in keyspace {{"{{"}} $labels.keyspace {{"}}"}}."
      expr: sum by (keyspace, table) (cassandra_table_bytesunrepaired{table!="",job="cassandra-servers-svc"}) > {{ .cassandra.unrepairedSize }}
      for: {{ .period.tinyDelay }}
      labels:
        severity: critical
        namespace: cattle-monitoring-system
    - alert: Concurrent_Cronjob_Is_Allowed_In_{{ .environment | title }}
      annotations:
        description: "The concurrency_policy of cronjob {{"{{"}} $labels.cronjob {{"}}"}} is {{"{{"}} $labels.concurrency_policy {{"}}"}}."
        summary: "Please set the concurrency_policy of cronjob {{"{{"}} $labels.cronjob {{"}}"}} to 'Forbid' on cluster {{"{{"}} $labels.cluster_name {{"}}"}}."
      expr: kube_cronjob_info{concurrency_policy!="Forbid"}
      for: {{ .period.smallDelay }}
      labels:
        severity: warning
        namespace: cattle-monitoring-system
    - alert: Cronjob_Is_Suspended_In_{{ .environment | title }}
      annotations:
        description: "The cronjob {{"{{"}} $labels.cronjob {{"}}"}} is suspended for more than {{ trimSuffix "m" .period.tinyDelay }} minutes."
        summary: "Please set the suspension field of cronjob  {{"{{"}} $labels.cronjob {{"}}"}} to 'false' on cluster {{"{{"}} $labels.cluster_name {{"}}"}}."
      expr: kube_cronjob_spec_suspend > 0
      for: {{ .period.tinyDelay }}
      labels:
        severity: warning
        namespace: cattle-monitoring-system
{{- end }}
{{- end }}
