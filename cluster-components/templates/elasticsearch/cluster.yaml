{{- if .Values.elasticsearch.enabled -}}
{{- range $clusterName, $clusterConfig := .Values.elasticsearch.deployments }}
{{- $nodeName := $clusterConfig.nodeName | default $.Values.elasticsearch.nodeName | default "default" -}}
{{- $version := $clusterConfig.version | default $.Values.elasticsearch.version -}}
{{- $disableTLS := $clusterConfig.disableTLS | default $.Values.elasticsearch.disableTLS | default false -}}
{{- $disableSecurity := $clusterConfig.disableSecurity | default $.Values.elasticsearch.disableSecurity | default false -}}
{{- $volumeClaimTemplates := $clusterConfig.volumeClaimTemplates | default $.Values.elasticsearch.volumeClaimTemplates -}}
---
apiVersion: elasticsearch.k8s.elastic.co/v1
kind: Elasticsearch
metadata:
  name: {{ $clusterName }}
  namespace: {{ $.Values.elasticsearch.namespace }}
spec:
  version: {{ $version }}
  nodeSets:
  - name: {{ $nodeName }}
    count: {{ $clusterConfig.replicas | default 1 }}
    podTemplate:
      spec:
        containers:
        - name: elasticsearch
          env:
          - name: ES_JAVA_OPTS
            value: -Xms1g -Xmx1g
    {{ if $volumeClaimTemplates }}
    volumeClaimTemplates:
      {{- toYaml $volumeClaimTemplates | nindent 4 }}
    {{- end }}
    config:
      node.store.allow_mmap: false
      {{- if $disableSecurity }}
      # This disables the default authentication but prints a warning in the
      # cluster health status view, nonetheless it's working as expected
      # Warning Validation 80s (x63 over 6m24s) elasticsearch-controller
      # [spec.nodeSets[0].config.xpack.security.enabled: Forbidden:
      # Configuration setting is reserved for internal use. User-configured
      # use is unsupported,
      # spec.nodeSets[0].config.xpack.security.http.ssl.enabled: Forbidden:
      # Configuration setting is reserved for internal use. User-configured
      # use is unsupported]
      # https://discuss.elastic.co/t/dont-want-to-use-https-and-user-password/202332
      xpack.security.enabled: false
      # xpack.security.http.ssl.enabled: true
      {{ end }}
  {{- if $disableTLS }}
  http:
    tls:
      selfSignedCertificate:
        disabled: true
  {{ end }}
{{ end }}
{{ end }}
