{{- if and .Values.metallb.enabled .Values.metallb.pinnedIpAddressPool -}}
{{- $cluster_name :=
  required
    (print "Cluster name configuration key <.Values.clusterName> required")
    .Values.clusterName -}}
{{- $ipAddressPoolName := print $cluster_name "-metallb-pool-pinned" -}}
{{- $ipAddressPool :=
  required
    (print "IP address pool configuration key <.Values.metallb.pinnedIpAddressPool.ipAddressPool> required")
    .Values.metallb.pinnedIpAddressPool.ipAddressPool -}}
{{- $serviceAllocation :=
  required
    (print "ServiceAllocation pool configuration key <.Values.metallb.pinnedIpAddressPool.serviceAllocation> required")
    .Values.metallb.pinnedIpAddressPool.serviceAllocation -}}
---
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: l2-advertisement-pinned
  namespace: metallb
spec:
  ipAddressPools:
  - {{ $ipAddressPoolName }}
---
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: {{ $ipAddressPoolName }}
  namespace: metallb
spec:
  addresses:
    {{- toYaml $ipAddressPool | nindent 4 }}
  serviceAllocation:
    {{- toYaml $serviceAllocation | nindent 4 }}

{{ end }}
