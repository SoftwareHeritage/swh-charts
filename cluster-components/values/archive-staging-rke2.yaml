# Relay prometheus alerts to the admin cluster's ingress relay
alertmanager:
  enabled: true

alertmanagerConfig:
  enabled: true

podPriority:
  enabled: true

svix:
  enabled: true
  version: v1.16
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: svix-server
            operator: In
            values:
            - "true"
  ingress:
    host: svix.internal.staging.swh.network
    createTLS: true
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-production-gandi
      kubernetes.io/tls-acme: "true"
      nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    whitelistSourceRange:
      # cluster internal range ip
      - 10.42.0.0/16
      - 10.43.0.0/16
      # admin ip
      - 192.168.50.0/24
  requestedMemory: 100Mi
  requestedCpu: 100m
  namespace: svix-server
  redisDsn: redis-svix.svix-server
  postgresDsn: db1.internal.staging.swh.network

alerting:
  enabled: true
  environment: staging

scrapeExternalMetrics:
  enabled: true
  deployments:
    cassandra:
      namespace: cassandra
      metricsName: jmx-exporter
      serviceMonitorName: cassandra-jmx-exporter
      port: 7070
      ips:
        - 192.168.130.181
        - 192.168.130.182
        - 192.168.130.183
      relabelings:
        # https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_config
        - sourceLabels:
            - __address__
          targetLabel: __address__
          regex: "192.168.130.18(\\d)(.*)"
          replacement: "cassandra$1.internal.staging.swh.network$2"
          action: replace
    # Integrate the rabbitmq metrics into the cluster. To allow crafting alertmanager
    # alerts. With this, we need to deactivate the prometheus scrapping from pergamon to
    # avoid duplicates (those are not readable from the cluster alertmanager)
    rabbitmq:
      namespace: rabbitmq
      port: 9419
      ips:
        - 192.168.130.50
      relabelings:
        # https://prometheus.io/docs/prometheus/latest/configuration/configuration/#relabel_config
        - sourceLabels:
            - __address__
          targetLabel: __address__
          regex: "192.168.130.50(.*)"
          replacement: "scheduler0.internal.staging.swh.network$1"
          action: replace
